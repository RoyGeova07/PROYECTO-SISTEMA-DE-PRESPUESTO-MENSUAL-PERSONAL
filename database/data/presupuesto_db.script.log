/*C5*/SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
CREATE PROCEDURE SP_INSERTAR_OBLIGACION\u000d\u000a(\u000d\u000a\u000d\u000a\u0009IN p_id_usuario BIGINT,\u000d\u000a    IN p_id_subcategoria BIGINT,\u000d\u000a    IN p_nombre VARCHAR(70),\u000d\u000a    IN p_descripcion VARCHAR(500),\u000d\u000a    IN p_monto DECIMAL(14,2),\u000d\u000a    IN p_dia_vencimiento SMALLINT,\u000d\u000a    IN p_fecha_inicio DATE,\u000d\u000a    IN p_fecha_fin DATE,\u000d\u000a    IN p_creado_por VARCHAR(100)\u000d\u000a\u000d\u000a)\u000d\u000aMODIFIES SQL DATA\u000d\u000aBEGIN ATOMIC \u000d\u000a\u0009DECLARE v_count INT;\u000d\u000a    DECLARE v_tipo_categoria VARCHAR(15);\u000d\u000a\u0009 SELECT COUNT(*) INTO v_count FROM USUARIOS WHERE Id_usuario=p_id_usuario;\u000d\u000a    IF v_count=0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='El usuario indicado no existe';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a\u0009--validar q la subcategoria existe  y obtener tipo de categoria usando join\u000d\u000a\u0009SELECT c.Tipo_de_categoria INTO v_tipo_categoria\u000d\u000a    FROM SUBCATEGORIA s\u000d\u000a    LEFT JOIN CATEGORIA c ON c.Id_categoria=s.Id_categoria\u000d\u000a    WHERE s.Id_subcategoria=p_id_subcategoria;\u000d\u000a\u0009\u000d\u000a\u0009 IF v_tipo_categoria IS NULL THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='La subcategoria indicada no existe';\u000d\u000a    END IF;\u000d\u000a\u0009 \u000d\u000a\u0009 --ahora validar que la subcategoria sea de tipo gasto\u000d\u000a\u0009 IF lower(v_tipo_categoria)<>'gasto'THEN\u000d\u000a\u0009 \u0009 SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='La subcategoroa asociada debe ser de tipo ''gasto'' para una obligacion fija';\u000d\u000a\u0009 END IF;\u000d\u000a\u0009 \u000d\u000a\u0009 --validar dia de vencimiento \u000d\u000a\u0009 IF p_dia_vencimiento<1 OR p_dia_vencimiento>31 THEN\u000d\u000a\u0009 \u0009 SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='El d\u00eda de vencimiento debe estar entre 1 y 31';\u000d\u000a     END IF;\u000d\u000a\u0009 \u000d\u000a\u0009 --validar fechas, si fecha_fin no es null debe ser mayor que fecha_inicio\u000d\u000a\u0009 IF p_fecha_fin IS NOT NULL THEN\u000d\u000a        IF p_fecha_fin<=p_fecha_inicio THEN\u000d\u000a            SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='La fecha de finalizacion debe ser posterior a la fecha de inicio';\u000d\u000a        END IF;\u000d\u000a     END IF;\u000d\u000a\u0009 \u000d\u000a\u0009 IF p_monto<0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT='El monto no puede ser negativo';\u000d\u000a     END IF;\u000d\u000a\u0009 \u000d\u000a\u0009 --validar unicidaddd\u000d\u000a\u0009 SELECT count(*)INTO v_count FROM OBLIGACION_FIJA WHERE Id_subcategoria=p_id_subcategoria;\u000d\u000a\u0009  IF v_count>0 THEN\u000d\u000a        SIGNAL SQLSTATE'45000'SET MESSAGE_TEXT='Ya existe una obligacion asociada a esa subcategoria';\u000d\u000a      END IF;\u000d\u000a\u0009 \u000d\u000a\u0009 INSERT INTO OBLIGACION_FIJA\u000d\u000a\u0009 (\u000d\u000a\u0009 \u000d\u000a\u0009 \u0009Id_usuario,\u000d\u000a        Id_subcategoria,\u000d\u000a        Nombre,\u000d\u000a        Descripcion_detallada,\u000d\u000a        Monto_fijo_mensual,\u000d\u000a        Dia_del_mes_de_vencimiento,\u000d\u000a        Esta_vigente,\u000d\u000a        Fecha_inicio_de_la_obligacion,\u000d\u000a        Fecha_de_finalizacion,\u000d\u000a        creado_en,\u000d\u000a        creado_por\u000d\u000a\u0009 \u000d\u000a\u0009 )values(\u000d\u000a\u0009 \u000d\u000a\u0009 \u0009 p_id_usuario,\u000d\u000a        p_id_subcategoria,\u000d\u000a        p_nombre,\u000d\u000a        p_descripcion,\u000d\u000a        p_monto,\u000d\u000a        p_dia_vencimiento,\u000d\u000a        TRUE,\u000d\u000a        p_fecha_inicio,\u000d\u000a        p_fecha_fin,\u000d\u000a        CURRENT_TIMESTAMP,\u000d\u000a        COALESCE(p_creado_por,'system')\u000d\u000a\u0009 \u000d\u000a\u0009 );\u000d\u000aEND
CREATE PROCEDURE SP_ACTUALIZAR_OBLIGACION\u000d\u000a(\u000d\u000a\u000d\u000a\u0009IN p_id_obligacion BIGINT,\u000d\u000a    IN p_nombre VARCHAR(70),\u000d\u000a    IN p_descripcion VARCHAR(500),\u000d\u000a    IN p_monto DECIMAL(14,2),\u000d\u000a    IN p_dia_vencimiento SMALLINT,\u000d\u000a    IN p_fecha_fin DATE,\u000d\u000a    IN p_activo BOOLEAN,\u000d\u000a    IN p_modificado_por VARCHAR(100)\u000d\u000a\u000d\u000a)\u000d\u000aMODIFIES SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a    DECLARE v_count INT;\u000d\u000a\u0009DECLARE v_fecha_inicio DATE;\u000d\u000a\u0009 SELECT COUNT(*) INTO v_count FROM OBLIGACION_FIJA WHERE Id_obligacion_fija=p_id_obligacion;\u000d\u000a    IF v_count=0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='La obligacion indicada no existe';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a\u0009IF p_monto<0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='El monto no puede ser negativo';\u000d\u000a    END IF;\u000d\u000a    IF p_dia_vencimiento<1 OR p_dia_vencimiento>31 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='El d\u00eda de vencimiento debe estar entre 1 y 31';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009--si fecha_fin no es null, obtener fecha_inicio para comparar\u000d\u000a\u0009IF p_fecha_fin IS NOT NULL THEN\u000d\u000a        SELECT Fecha_inicio_de_la_obligacion INTO v_fecha_inicio FROM OBLIGACION_FIJA WHERE Id_obligacion_fija=p_id_obligacion;\u000d\u000a        IF p_fecha_fin<=v_fecha_inicio THEN\u000d\u000a            SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='La fecha de finalizacion debe ser posterior a la fecha de inicio';\u000d\u000a        END IF;\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009UPDATE OBLIGACION_FIJA\u000d\u000a    SET Nombre=p_nombre,\u000d\u000a        Descripcion_detallada=p_descripcion,\u000d\u000a        Monto_fijo_mensual=p_monto,\u000d\u000a        Dia_del_mes_de_vencimiento=p_dia_vencimiento,\u000d\u000a        Fecha_de_finalizacion=p_fecha_fin,\u000d\u000a        Esta_vigente=COALESCE(p_activo, Esta_vigente),\u000d\u000a        modificado_en=CURRENT_TIMESTAMP,\u000d\u000a        modificado_por=COALESCE(p_modificado_por,'system')\u000d\u000a    WHERE Id_obligacion_fija=p_id_obligacion;\u000d\u000aEND
CREATE FUNCTION SP_LISTAR_OBLIGACIONES_USUARIO(p_id_usuario BIGINT, p_activo BOOLEAN)\u000d\u000aRETURNS table\u000d\u000a(\u000d\u000a\u000d\u000a\u0009Id_obligacion_fija BIGINT,\u000d\u000a    Id_usuario BIGINT,\u000d\u000a    Id_subcategoria BIGINT,\u000d\u000a    Nombre varchar(70),\u000d\u000a    Descripcion_detallada varchar(500),\u000d\u000a    Monto_fijo_mensual DECIMAL(14,2),\u000d\u000a    Dia_del_mes_de_vencimiento SMALLINT,\u000d\u000a    Esta_vigente BOOLEAN,\u000d\u000a    Fecha_inicio_de_la_obligacion DATE,\u000d\u000a    Fecha_de_finalizacion DATE,\u000d\u000a    Nombre_subcategoria VARCHAR(100),\u000d\u000a    Id_categoria BIGINT,\u000d\u000a    Nombre_categoria VARCHAR(100),\u000d\u000a    creado_en TIMESTAMP,\u000d\u000a    modificado_en TIMESTAMP,\u000d\u000a    creado_por VARCHAR(100),\u000d\u000a    modificado_por VARCHAR(100)\u000d\u000a\u000d\u000a)\u000d\u000aREADS SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a    DECLARE v_count INT;\u000d\u000a    SELECT COUNT(*) INTO v_count FROM USUARIOS WHERE Id_usuario =p_id_usuario;\u000d\u000a    IF v_count =0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT='El usuario indicado no existe';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a\u0009RETURN TABLE\u000d\u000a\u0009(\u000d\u000a\u0009\u000d\u000a\u0009\u0009 SELECT\u000d\u000a            o.Id_obligacion_fija,\u000d\u000a            o.Id_usuario,\u000d\u000a            o.Id_subcategoria,\u000d\u000a            o.Nombre,\u000d\u000a            o.Descripcion_detallada,\u000d\u000a            o.Monto_fijo_mensual,\u000d\u000a            o.Dia_del_mes_de_vencimiento,\u000d\u000a            o.Esta_vigente,\u000d\u000a            o.Fecha_inicio_de_la_obligacion,\u000d\u000a            o.Fecha_de_finalizacion,\u000d\u000a            s.Nombre_subcategoria,\u000d\u000a            s.Id_categoria,\u000d\u000a            c.Nombre AS Nombre_categoria,\u000d\u000a            o.creado_en,\u000d\u000a            o.modificado_en,\u000d\u000a            o.creado_por,\u000d\u000a            o.modificado_por\u000d\u000a         FROM OBLIGACION_FIJA o\u000d\u000a         LEFT JOIN SUBCATEGORIA s ON s.Id_subcategoria=o.Id_subcategoria\u000d\u000a         LEFT JOIN CATEGORIA c ON c.Id_categoria=s.Id_categoria\u000d\u000a         WHERE o.Id_usuario=p_id_usuario AND (p_activo IS NULL OR o.Esta_vigente=p_activo)\u000d\u000a         ORDER BY o.Id_obligacion_fija\u000d\u000a         \u000d\u000a\u0009);\u000d\u000aEND
CREATE FUNCTION SP_CONSULTAR_OBLIGACION(p_id_obligacion BIGINT)\u000d\u000aRETURNS TABLE \u000d\u000a(\u000d\u000a\u000d\u000a\u0009Id_obligacion_fija BIGINT,\u000d\u000a    Id_usuario BIGINT,\u000d\u000a    Id_subcategoria BIGINT,\u000d\u000a    Nombre varchar(70),\u000d\u000a    Descripcion_detallada varchar(500),\u000d\u000a    Monto_fijo_mensual DECIMAL(14,2),\u000d\u000a    Dia_del_mes_de_vencimiento SMALLINT,\u000d\u000a    Esta_vigente BOOLEAN,\u000d\u000a    Fecha_inicio_de_la_obligacion DATE,\u000d\u000a    Fecha_de_finalizacion DATE,\u000d\u000a    Nombre_subcategoria VARCHAR(100),\u000d\u000a    Id_categoria BIGINT,\u000d\u000a    Nombre_categoria VARCHAR(100),\u000d\u000a    creado_en TIMESTAMP,\u000d\u000a    modificado_en TIMESTAMP,\u000d\u000a    creado_por VARCHAR(100),\u000d\u000a    modificado_por VARCHAR(100)\u000d\u000a\u000d\u000a)\u000d\u000aREADS SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a    DECLARE v_count INT;\u000d\u000a\u0009 SELECT COUNT(*) INTO v_count FROM OBLIGACION_FIJA WHERE Id_obligacion_fija =p_id_obligacion;\u000d\u000a    IF v_count = 0 THEN\u000d\u000a        SIGNAL SQLSTATE'45000' SET MESSAGE_TEXT= 'La obligaci\u00f3n indicada no existe';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a\u0009RETURN TABLE\u000d\u000a\u0009(\u000d\u000a\u0009\u000d\u000a\u0009\u0009 SELECT\u000d\u000a            o.Id_obligacion_fija,\u000d\u000a            o.Id_usuario,\u000d\u000a            o.Id_subcategoria,\u000d\u000a            o.Nombre,\u000d\u000a            o.Descripcion_detallada,\u000d\u000a            o.Monto_fijo_mensual,\u000d\u000a            o.Dia_del_mes_de_vencimiento,\u000d\u000a            o.Esta_vigente,\u000d\u000a            o.Fecha_inicio_de_la_obligacion,\u000d\u000a            o.Fecha_de_finalizacion,\u000d\u000a            s.Nombre_subcategoria,\u000d\u000a            s.Id_categoria,\u000d\u000a            c.Nombre AS Nombre_categoria,\u000d\u000a            o.creado_en,\u000d\u000a            o.modificado_en,\u000d\u000a            o.creado_por,\u000d\u000a            o.modificado_por\u000d\u000a         FROM OBLIGACION_FIJA O\u000d\u000a         LEFT JOIN SUBCATEGORIA s ON  s.Id_subcategoria=o.Id_subcategoria\u000d\u000a         LEFT JOIN CATEGORIA c ON c.Id_categoria=s.Id_categoria\u000d\u000a         WHERE o.Id_obligacion_fija=p_id_obligacion\u000d\u000a\u0009\u000d\u000a\u0009);\u000d\u000aEND
/*C6*/SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
/*C5*/INSERT INTO OBLIGACION_FIJA VALUES(1,1,1,'Prueba fallo tipo','Esto debe fallar si la subcategoria no es gasto',100.00,10,TRUE,'2025-01-01',NULL,'2025-12-02 20:05:09.739448',NULL,'royum',NULL)
COMMIT
/*C7*/SET SCHEMA PUBLIC
DISCONNECT
/*C8*/SET SCHEMA PUBLIC
DISCONNECT
/*C9*/SET SCHEMA PUBLIC
INSERT INTO OBLIGACION_FIJA VALUES(2,1,4,'Alquiler mensual','Pago mensual de renta',5000.00,5,TRUE,'2025-01-01',NULL,'2025-12-02 20:19:09.744108',NULL,'royum',NULL)
COMMIT
DISCONNECT
/*C10*/SET SCHEMA PUBLIC
DELETE FROM OBLIGACION_FIJA WHERE ID_OBLIGACION_FIJA=1
INSERT INTO OBLIGACION_FIJA VALUES(1,1,1,'Alquiler actualizado','Ajuste por convenio',5200.00,5,TRUE,'2025-01-01','2026-12-31','2025-12-02 20:05:09.739448','2025-12-02 20:28:17.515209','royum','royum')
COMMIT
DISCONNECT
/*C11*/SET SCHEMA PUBLIC
DISCONNECT
/*C12*/SET SCHEMA PUBLIC
DISCONNECT
/*C13*/SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
/*C14*/SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
\u000d\u000aCREATE PROCEDURE SP_INSERTAR_TRANSACCION\u000d\u000a(\u000d\u000a\u000d\u000a\u0009IN p_id_usuario BIGINT,\u000d\u000a    IN p_id_presupuesto BIGINT,\u000d\u000a    IN p_anio SMALLINT,\u000d\u000a    IN p_mes SMALLINT,\u000d\u000a    IN p_id_subcategoria BIGINT,\u000d\u000a    IN p_id_obligacion BIGINT,--nullable\u000d\u000a    IN p_tipo VARCHAR(15),\u000d\u000a    IN p_descripcion VARCHAR(500),\u000d\u000a    IN p_monto DECIMAL(14,2),\u000d\u000a    IN p_fecha DATE,\u000d\u000a    IN p_metodo_pago VARCHAR(30),\u000d\u000a    IN p_creado_por VARCHAR(100)\u000d\u000a\u000d\u000a)\u000d\u000aMODIFIES SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a     -- DECLARACIONES al inicio\u000d\u000a    DECLARE v_count INT;\u000d\u000a    DECLARE v_tipo_categoria VARCHAR(15);\u000d\u000a    DECLARE v_presu_anio SMALLINT;\u000d\u000a    DECLARE v_presu_mes SMALLINT;\u000d\u000a    DECLARE v_presu_anio_fin SMALLINT;\u000d\u000a    DECLARE v_presu_mes_fin SMALLINT;\u000d\u000a\u000d\u000a    -- validar usuario\u000d\u000a    SELECT COUNT(*) INTO v_count FROM USUARIOS WHERE Id_usuario = p_id_usuario;\u000d\u000a    IF v_count = 0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Usuario no existe';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a    -- validar presupuesto\u000d\u000a    SELECT COUNT(*) INTO v_count FROM PRESUPUESTO WHERE Id_presupuesto = p_id_presupuesto;\u000d\u000a    IF v_count = 0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Presupuesto no existe';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a    -- validar subcategoria y obtener tipo de categoria padre\u000d\u000a    SELECT c.Tipo_de_categoria\u000d\u000a      INTO v_tipo_categoria\u000d\u000a      FROM SUBCATEGORIA s\u000d\u000a      LEFT JOIN CATEGORIA c ON c.Id_categoria = s.Id_categoria\u000d\u000a     WHERE s.Id_subcategoria = p_id_subcategoria;\u000d\u000a\u000d\u000a    IF v_tipo_categoria IS NULL THEN\u000d\u000a        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Subcategor\u00eda no existe';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a    -- validar que p_tipo coincide con tipo de categoria padre\u000d\u000a    IF LOWER(p_tipo) <> LOWER(v_tipo_categoria) THEN\u000d\u000a        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Tipo de transaccion no coincide con tipo de la categoria padre';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a    -- si viene id_obligacion, validar que existe y que usa la misma subcategoria\u000d\u000a    IF p_id_obligacion IS NOT NULL THEN\u000d\u000a        SELECT COUNT(*) INTO v_count FROM OBLIGACION_FIJA WHERE Id_obligacion_fija = p_id_obligacion;\u000d\u000a        IF v_count = 0 THEN\u000d\u000a            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Obligaci\u00f3n indicada no existe';\u000d\u000a        END IF;\u000d\u000a\u000d\u000a        SELECT COUNT(*) INTO v_count\u000d\u000a        FROM OBLIGACION_FIJA\u000d\u000a        WHERE Id_obligacion_fija = p_id_obligacion\u000d\u000a          AND Id_subcategoria = p_id_subcategoria;\u000d\u000a\u000d\u000a        IF v_count = 0 THEN\u000d\u000a            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'La obligacion no corresponde a la subcategoria indicada';\u000d\u000a        END IF;\u000d\u000a    END IF;\u000d\u000a\u000d\u000a    -- validaciones de monto y mes\u000d\u000a    IF p_monto < 0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'El monto no puede ser negativo';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a    IF p_mes < 1 OR p_mes > 12 THEN\u000d\u000a        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Mes invalido (1..12)';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a    -- validar vigencia del presupuesto (obtener periodos)\u000d\u000a    SELECT Anio_de_inicio, Mes_de_inicio, Anio_de_fin, Mes_de_fin\u000d\u000a      INTO v_presu_anio, v_presu_mes, v_presu_anio_fin, v_presu_mes_fin\u000d\u000a    FROM PRESUPUESTO\u000d\u000a    WHERE Id_presupuesto = p_id_presupuesto;\u000d\u000a\u000d\u000a    IF NOT (\u000d\u000a        (p_anio > v_presu_anio OR (p_anio = v_presu_anio AND p_mes >= v_presu_mes))\u000d\u000a        AND\u000d\u000a        (p_anio < v_presu_anio_fin OR (p_anio = v_presu_anio_fin AND p_mes <= v_presu_mes_fin))\u000d\u000a    ) THEN\u000d\u000a        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'A\u00f1o/Mes fuera del periodo de vigencia del presupuesto';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009--ahora si insertar\u000d\u000a\u0009INSERT INTO TRANSACCION\u000d\u000a\u0009(\u000d\u000a\u0009\u000d\u000a\u0009\u0009Id_usuario,\u000d\u000a        Id_presupuesto,\u000d\u000a        Anio,\u000d\u000a        Mes,\u000d\u000a        Id_subcategoria,\u000d\u000a        Id_obligacion_fija,\u000d\u000a        Tipo_de_transaccion,\u000d\u000a        Descripcion,\u000d\u000a        Monto,\u000d\u000a        Fecha,\u000d\u000a        Metodo_de_pago,\u000d\u000a        Fecha_hora_de_registro,\u000d\u000a        creado_en,\u000d\u000a        creado_por\u000d\u000a\u0009\u000d\u000a\u0009)values(\u000d\u000a\u0009\u000d\u000a\u0009\u0009p_id_usuario,\u000d\u000a        p_id_presupuesto,\u000d\u000a        p_anio,\u000d\u000a        p_mes,\u000d\u000a        p_id_subcategoria,\u000d\u000a        p_id_obligacion,\u000d\u000a        LOWER(p_tipo),\u000d\u000a        p_descripcion,\u000d\u000a        p_monto,\u000d\u000a        p_fecha,\u000d\u000a        LOWER(p_metodo_pago),\u000d\u000a        CURRENT_TIMESTAMP,\u000d\u000a        CURRENT_TIMESTAMP,\u000d\u000a        COALESCE(p_creado_por,'system')\u000d\u000a\u0009\u000d\u000a\u0009);\u000d\u000aEND
CREATE PROCEDURE SP_ACTUALIZAR_TRANSACCION\u000d\u000a(\u000d\u000a\u000d\u000a\u0009IN p_id_transaccion BIGINT,\u000d\u000a    IN p_anio SMALLINT,\u000d\u000a    IN p_mes SMALLINT,\u000d\u000a    IN p_descripcion VARCHAR(500),\u000d\u000a    IN p_monto DECIMAL(14,2),\u000d\u000a    IN p_fecha DATE,\u000d\u000a    IN p_metodo_pago VARCHAR(30),\u000d\u000a    IN p_modificado_por VARCHAR(100)\u000d\u000a\u000d\u000a)\u000d\u000aMODIFIES SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a    DECLARE v_count INT;\u000d\u000a    DECLARE v_presu_id BIGINT;\u000d\u000a    DECLARE v_presu_anio SMALLINT;\u000d\u000a    DECLARE v_presu_mes SMALLINT;\u000d\u000a    DECLARE v_presu_anio_fin SMALLINT;\u000d\u000a    DECLARE v_presu_mes_fin SMALLINT;\u000d\u000a\u000d\u000a\u0009SELECT COUNT(*) INTO v_count FROM TRANSACCION WHERE Id_transaccion=p_id_transaccion;\u000d\u000a    IF v_count =0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='Transacci\u00f3n no existe';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009--aqui obtengo el presupuesto asociado\u000d\u000a\u0009SELECT Id_presupuesto INTO v_presu_id FROM TRANSACCION WHERE Id_transaccion=p_id_transaccion;\u000d\u000a\u0009\u000d\u000a\u0009IF p_monto<0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='El monto no puede ser negativo';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a    IF p_mes<1 OR p_mes>12 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='Mes invalido (1..12)';\u000d\u000a    END IF;\u000d\u000a    \u000d\u000a    --validar que p_anio/p_mes estn dentro de vigencia del presupuesto\u000d\u000a     SELECT Anio_de_inicio,Mes_de_inicio,Anio_de_fin,Mes_de_fin\u000d\u000a      INTO v_presu_anio,v_presu_mes,v_presu_anio_fin,v_presu_mes_fin\u000d\u000a    FROM PRESUPUESTO\u000d\u000a    WHERE Id_presupuesto=v_presu_id;\u000d\u000a    \u000d\u000a    IF NOT((p_anio>v_presu_anio OR(p_anio= v_presu_anio AND p_mes >=v_presu_mes))AND\u000d\u000a        (p_anio<v_presu_anio_fin OR(p_anio=v_presu_anio_fin AND p_mes<=v_presu_mes_fin)))THEN\u000d\u000a        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT ='A\u00f1o/Mes fuera del periodo de vigencia del presupuesto';\u000d\u000a    END IF;\u000d\u000a    \u000d\u000a    --ahora si actualizar\u000d\u000a     UPDATE TRANSACCION\u000d\u000a     SET Anio=p_anio,\u000d\u000a        Mes=p_mes,\u000d\u000a        Descripcion=p_descripcion,\u000d\u000a        Monto=p_monto,\u000d\u000a        Fecha=p_fecha,\u000d\u000a        Metodo_de_pago=LOWER(p_metodo_pago),\u000d\u000a        modificado_en=CURRENT_TIMESTAMP,\u000d\u000a        modificado_por=COALESCE(p_modificado_por,'system')\u000d\u000a    WHERE Id_transaccion=p_id_transaccion;\u000d\u000aEND
CREATE PROCEDURE SP_ELIMINAR_TRANSACCION\u000d\u000a(\u000d\u000a\u000d\u000a\u0009IN p_id_transaccion BIGINT\u000d\u000a\u000d\u000a)\u000d\u000aMODIFIES SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a    DECLARE v_count INT;\u000d\u000a    SELECT COUNT(*)INTO v_count FROM TRANSACCION WHERE Id_transaccion=p_id_transaccion;\u000d\u000a    IF v_count=0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='Transaccion no existe';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a    DELETE FROM TRANSACCION WHERE Id_transaccion=p_id_transaccion;\u000d\u000aEND
CREATE FUNCTION SP_CONSULTAR_TRANSACCION(p_id_transaccion BIGINT)\u000d\u000aRETURNS table\u000d\u000a(\u000d\u000a\u000d\u000a\u0009Id_transaccion BIGINT,\u000d\u000a    Id_usuario BIGINT,\u000d\u000a    Id_presupuesto BIGINT,\u000d\u000a    Anio SMALLINT,\u000d\u000a    Mes SMALLINT,\u000d\u000a    Id_subcategoria BIGINT,\u000d\u000a    Id_obligacion_fija BIGINT,\u000d\u000a    Tipo_de_transaccion VARCHAR(15),\u000d\u000a    Descripcion VARCHAR(500),\u000d\u000a    Monto DECIMAL(14,2),\u000d\u000a    Fecha DATE,\u000d\u000a    Metodo_de_pago VARCHAR(30),\u000d\u000a    Fecha_hora_de_registro TIMESTAMP,\u000d\u000a    creado_en TIMESTAMP,\u000d\u000a    modificado_en TIMESTAMP,\u000d\u000a    creado_por VARCHAR(100),\u000d\u000a    modificado_por VARCHAR(100),\u000d\u000a    Nombre_subcategoria VARCHAR(100),\u000d\u000a    Id_categoria BIGINT,\u000d\u000a    Nombre_categoria VARCHAR(100)\u000d\u000a\u000d\u000a)\u000d\u000aREADS SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a    DECLARE v_count INT;\u000d\u000a\u0009SELECT COUNT(*) INTO v_count FROM TRANSACCION WHERE Id_transaccion=p_id_transaccion;\u000d\u000a    IF v_count=0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT='Transacci\u00f3n no existe';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a\u0009RETURN TABLE\u000d\u000a\u0009(\u000d\u000a\u0009\u000d\u000a\u0009\u0009 SELECT\u000d\u000a            t.Id_transaccion,\u000d\u000a            t.Id_usuario,\u000d\u000a            t.Id_presupuesto,\u000d\u000a            t.Anio,\u000d\u000a            t.Mes,\u000d\u000a            t.Id_subcategoria,\u000d\u000a            t.Id_obligacion_fija,\u000d\u000a            t.Tipo_de_transaccion,\u000d\u000a            t.Descripcion,\u000d\u000a            t.Monto,\u000d\u000a            t.Fecha,\u000d\u000a            t.Metodo_de_pago,\u000d\u000a            t.Fecha_hora_de_registro,\u000d\u000a            t.creado_en,\u000d\u000a            t.modificado_en,\u000d\u000a            t.creado_por,\u000d\u000a            t.modificado_por,\u000d\u000a            s.Nombre_subcategoria,\u000d\u000a            s.Id_categoria,\u000d\u000a            c.Nombre AS Nombre_categoria\u000d\u000a        FROM TRANSACCION t\u000d\u000a        LEFT JOIN SUBCATEGORIA s ON s.Id_subcategoria=t.Id_subcategoria\u000d\u000a        LEFT JOIN CATEGORIA c ON c.Id_categoria=s.Id_categoria\u000d\u000a        WHERE t.Id_transaccion=p_id_transaccion\u000d\u000a\u0009\u000d\u000a\u0009);\u000d\u000aEND
CREATE FUNCTION SP_LISTAR_TRANSACCIONES_PRESUPUESTO\u000d\u000a(\u000d\u000a\u000d\u000a\u0009p_id_presupuesto BIGINT,\u000d\u000a    p_anio SMALLINT,\u000d\u000a    p_mes SMALLINT,\u000d\u000a    p_tipo VARCHAR(15)\u000d\u000a\u000d\u000a)\u000d\u000aRETURNS TABLE\u000d\u000a(\u000d\u000a\u000d\u000a\u0009 Id_transaccion BIGINT,\u000d\u000a    Id_usuario BIGINT,\u000d\u000a    Id_presupuesto BIGINT,\u000d\u000a    Anio SMALLINT,\u000d\u000a    Mes SMALLINT,\u000d\u000a    Id_subcategoria BIGINT,\u000d\u000a    Id_obligacion_fija BIGINT,\u000d\u000a    Tipo_de_transaccion VARCHAR(15),\u000d\u000a    Descripcion VARCHAR(500),\u000d\u000a    Monto DECIMAL(14,2),\u000d\u000a    Fecha DATE,\u000d\u000a    Metodo_de_pago VARCHAR(30),\u000d\u000a    Fecha_hora_de_registro TIMESTAMP,\u000d\u000a    creado_en TIMESTAMP,\u000d\u000a    modificado_en TIMESTAMP,\u000d\u000a    creado_por VARCHAR(100),\u000d\u000a    modificado_por VARCHAR(100),\u000d\u000a    Nombre_subcategoria VARCHAR(100),\u000d\u000a    Id_categoria BIGINT,\u000d\u000a    Nombre_categoria VARCHAR(100)\u000d\u000a\u000d\u000a)\u000d\u000aREADS SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a    DECLARE v_count INT;\u000d\u000a    SELECT COUNT(*) INTO v_count FROM PRESUPUESTO WHERE Id_presupuesto = p_id_presupuesto;\u000d\u000a    IF v_count = 0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Presupuesto no existe';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a\u0009RETURN TABLE\u000d\u000a\u0009(\u000d\u000a\u0009\u000d\u000a\u0009\u0009SELECT\u000d\u000a            t.Id_transaccion,\u000d\u000a            t.Id_usuario,\u000d\u000a            t.Id_presupuesto,\u000d\u000a            t.Anio,\u000d\u000a            t.Mes,\u000d\u000a            t.Id_subcategoria,\u000d\u000a            t.Id_obligacion_fija,\u000d\u000a            t.Tipo_de_transaccion,\u000d\u000a            t.Descripcion,\u000d\u000a            t.Monto,\u000d\u000a            t.Fecha,\u000d\u000a            t.Metodo_de_pago,\u000d\u000a            t.Fecha_hora_de_registro,\u000d\u000a            t.creado_en,\u000d\u000a            t.modificado_en,\u000d\u000a            t.creado_por,\u000d\u000a            t.modificado_por,\u000d\u000a            s.Nombre_subcategoria,\u000d\u000a            s.Id_categoria,\u000d\u000a            c.Nombre AS Nombre_categoria\u000d\u000a        FROM TRANSACCION t\u000d\u000a        LEFT JOIN SUBCATEGORIA s ON s.Id_subcategoria=t.Id_subcategoria\u000d\u000a        LEFT JOIN CATEGORIA c ON c.Id_categoria=s.Id_categoria\u000d\u000a        WHERE t.Id_presupuesto=p_id_presupuesto\u000d\u000a          AND(p_anio IS NULL OR t.Anio=p_anio)\u000d\u000a          AND(p_mes  IS NULL OR t.Mes=p_mes)\u000d\u000a          AND(p_tipo IS NULL OR LOWER(t.Tipo_de_transaccion)=LOWER(p_tipo))\u000d\u000a        ORDER BY t.Fecha_hora_de_registro DESC\u000d\u000a\u0009\u000d\u000a\u0009);\u000d\u000aEND
INSERT INTO TRANSACCION VALUES(1,1,1,2025,2,1,NULL,'gasto','Compra supermercado',1200.00,'2025-02-10','efectivo','2025-12-02 23:13:30.914246','2025-12-02 23:13:30.914246',NULL,'royum',NULL)
COMMIT
/*C15*/SET SCHEMA PUBLIC
INSERT INTO TRANSACCION VALUES(2,1,1,2025,2,1,1,'gasto','Pago mensual - alquiler (prueba)',5000.00,'2025-02-05','transferencia','2025-12-02 23:23:29.791458','2025-12-02 23:23:29.791458',NULL,'royum',NULL)
COMMIT
DISCONNECT
/*C16*/SET SCHEMA PUBLIC
DISCONNECT
/*C17*/SET SCHEMA PUBLIC
DISCONNECT
/*C18*/SET SCHEMA PUBLIC
DISCONNECT
/*C19*/SET SCHEMA PUBLIC
DISCONNECT
/*C20*/SET SCHEMA PUBLIC
DELETE FROM TRANSACCION WHERE ID_TRANSACCION=1
INSERT INTO TRANSACCION VALUES(1,1,1,2025,2,1,NULL,'gasto','Descripci\u00f3n actualizada - cambio m\u00ednimo',1333.33,'2025-02-10','efectivo','2025-12-02 23:13:30.914246','2025-12-02 23:13:30.914246','2025-12-02 23:34:18.968513','royum','royum')
COMMIT
DISCONNECT
/*C21*/SET SCHEMA PUBLIC
DISCONNECT
/*C22*/SET SCHEMA PUBLIC
DISCONNECT
/*C23*/SET SCHEMA PUBLIC
DELETE FROM TRANSACCION WHERE ID_TRANSACCION=1
COMMIT
DISCONNECT
/*C5*/DISCONNECT
/*C24*/SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
/*C6*/DISCONNECT
/*C14*/DISCONNECT
/*C25*/SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
CREATE PROCEDURE SP_INSERTAR_META\u000d\u000a(\u000d\u000a\u000d\u000a\u0009IN p_id_usuario BIGINT,\u000d\u000a    IN p_id_subcategoria BIGINT,\u000d\u000a    IN p_nombre VARCHAR(70),\u000d\u000a    IN p_descripcion VARCHAR(500),\u000d\u000a    IN p_monto_objetivo DECIMAL(14,2),\u000d\u000a    IN p_fecha_inicio DATE,\u000d\u000a    IN p_fecha_objetivo DATE,\u000d\u000a    IN p_prioridad VARCHAR(10),\u000d\u000a    IN p_creado_por VARCHAR(100)\u000d\u000a\u000d\u000a)\u000d\u000aMODIFIES SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a    DECLARE v_count INT;\u000d\u000a    DECLARE v_tipo_categoria VARCHAR(15);\u000d\u000a\u000d\u000a\u0009SELECT COUNT(*) INTO v_count FROM USUARIOS WHERE Id_usuario=p_id_usuario;\u000d\u000a    IF v_count =0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='El usuario indicado no existe';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009--validar subcategoria existe y es de tipo ahorro\u000d\u000a\u0009SELECT c.Tipo_de_categoria INTO v_tipo_categoria\u000d\u000a\u0009FROM SUBCATEGORIA s\u000d\u000a\u0009LEFT JOIN CATEGORIA c ON c.Id_categoria=s.Id_categoria\u000d\u000a\u0009WHERE s.Id_subcategoria=p_id_subcategoria;\u000d\u000a\u0009\u000d\u000a\u0009IF v_tipo_categoria IS NULL THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='La subcategoria indicada no existe';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009IF lower(v_tipo_categoria)<>'ahorro'THEN\u000d\u000a\u0009\u0009  SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'La subcategoria debe ser de tipo ''ahorro''';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009IF p_fecha_objetivo<=p_fecha_inicio THEN\u000d\u000a        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT='La fecha objetivo debe ser posterior a la fecha de inicio';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009IF p_monto_objetivo<0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='El monto objetivo debe ser mayor o igual a 0';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009--asegurar que no exista ya una meta ACTIVA/en_progreso para esa subcategoria\u000d\u000a\u0009IF exists(SELECT 1 FROM META_AHORRO m\u000d\u000a\u0009WHERE m.Id_subcategoria=p_id_subcategoria AND m.Estado='en_progreso')then\u000d\u000a\u0009\u0009SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Ya existe una meta activa para esa subcategor\u00eda';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009\u000d\u000a\u0009INSERT INTO META_AHORRO\u000d\u000a\u0009(\u000d\u000a\u0009\u000d\u000a\u0009\u0009Id_usuario,\u000d\u000a        Id_subcategoria,\u000d\u000a        Nombre,\u000d\u000a        Descripcion_detallada,\u000d\u000a        Monto_total_alcanzar,\u000d\u000a        Monto_ahorrado,\u000d\u000a        Fecha_inicio,\u000d\u000a        Fecha_objetivo,\u000d\u000a        Prioridad,\u000d\u000a        Estado,\u000d\u000a        creado_en,\u000d\u000a        creado_por\u000d\u000a\u0009\u000d\u000a\u0009)values(\u000d\u000a\u0009\u000d\u000a\u0009\u0009p_id_usuario,\u000d\u000a        p_id_subcategoria,\u000d\u000a        p_nombre,\u000d\u000a        p_descripcion,\u000d\u000a        p_monto_objetivo,\u000d\u000a        0.00,--inicio con 0 ahorrado\u000d\u000a        p_fecha_inicio,\u000d\u000a        p_fecha_objetivo,\u000d\u000a        LOWER(COALESCE(p_prioridad,'media')),\u000d\u000a        'en_progreso',--al crear queda en_progreso por defecto\u000d\u000a        CURRENT_TIMESTAMP,\u000d\u000a        COALESCE(p_creado_por,'system')\u000d\u000a        \u000d\u000a    );\u000d\u000aEND
CREATE PROCEDURE SP_ACTUALIZAR_META\u000d\u000a(\u000d\u000a\u000d\u000a\u0009IN p_id_meta BIGINT,\u000d\u000a    IN p_nombre VARCHAR(70),\u000d\u000a    IN p_descripcion VARCHAR(500),\u000d\u000a    IN p_monto_objetivo DECIMAL(14,2),\u000d\u000a    IN p_fecha_objetivo DATE,\u000d\u000a    IN p_prioridad VARCHAR(10),\u000d\u000a    IN p_estado VARCHAR(10),\u000d\u000a    IN p_modificado_por VARCHAR(100)\u000d\u000a\u000d\u000a)\u000d\u000aMODIFIES SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a    DECLARE v_count INT;\u000d\u000a    DECLARE v_monto_ahorrado DECIMAL(14,2);\u000d\u000a\u0009DECLARE v_fecha_inicio DATE;\u000d\u000a\u0009DECLARE v_subcategoria BIGINT;\u000d\u000a\u0009\u000d\u000a\u0009 SELECT COUNT(*)INTO v_count FROM META_AHORRO WHERE Id_Ahorro=p_id_meta;\u000d\u000a    IF v_count=0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='La meta indicada no existe';\u000d\u000a    END IF;\u000d\u000a\u0009 \u000d\u000a\u0009--aqui obtengo el monto_ahorrado actual para validar\u000d\u000a\u0009SELECT Monto_ahorrado INTO v_monto_ahorrado FROM META_AHORRO WHERE Id_Ahorro=p_id_meta;\u000d\u000a\u0009\u000d\u000a\u0009--si cambian montos, validar que monto_ahorrado <= nuevo objetivo\u000d\u000a\u0009 IF p_monto_objetivo IS NOT NULL AND v_monto_ahorrado>p_monto_objetivo THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='No se puede disminuir el objetivo por debajo del monto ya ahorrado';\u000d\u000a     END IF;\u000d\u000a\u0009\u000d\u000a\u0009--si cambia fecha objetivo, validar que sea posterior a inicio actual\u000d\u000a\u0009 IF p_fecha_objetivo IS NOT NULL THEN\u000d\u000a        SELECT Fecha_inicio INTO v_fecha_inicio FROM META_AHORRO WHERE Id_Ahorro=p_id_meta;\u000d\u000a        IF p_fecha_objetivo<=v_fecha_inicio THEN\u000d\u000a            SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='La fecha objetivo debe ser posterior a la fecha de inicio';\u000d\u000a        END IF;\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009--si cambian estado a 'en_progreso' tengo q asegurarme que no hay otra meta en_progreso para la misma subcategoria\u000d\u000a\u0009IF p_estado='en_progreso'then\u000d\u000a\u0009\u0009SELECT Id_subcategoria INTO v_subcategoria FROM META_AHORRO WHERE Id_Ahorro = p_id_meta;\u000d\u000a\u0009\u0009IF exists(SELECT 1 FROM META_AHORRO m \u000d\u000a\u0009\u0009\u0009WHERE m.Id_subcategoria=v_subcategoria\u000d\u000a\u0009\u0009\u0009AND m.Estado='en_progreso'\u000d\u000a\u0009\u0009\u0009AND m.Id_ahorro<>p_id_meta)THEN\u000d\u000a\u0009     SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='Ya existe otra meta en progreso para la misma subcategoria';\u000d\u000a        END IF;\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009--ahora si actualizacionnnnnnnnnnnnnnnnnnnnnnnnnnnnnn,usare coalesce para para no sobrescribir con NULL si el parametro es NULL\u000d\u000a\u0009 UPDATE META_AHORRO\u000d\u000a     SET\u000d\u000a        Nombre=COALESCE(p_nombre, Nombre),\u000d\u000a        Descripcion_detallada=COALESCE(p_descripcion, Descripcion_detallada),\u000d\u000a        Monto_total_alcanzar=COALESCE(p_monto_objetivo, Monto_total_alcanzar),\u000d\u000a        Fecha_objetivo=COALESCE(p_fecha_objetivo, Fecha_objetivo),\u000d\u000a        Prioridad=COALESCE(LOWER(p_prioridad), Prioridad),\u000d\u000a        Estado=COALESCE(p_estado, Estado),\u000d\u000a        modificado_en=CURRENT_TIMESTAMP,\u000d\u000a        modificado_por=COALESCE(p_modificado_por, modificado_por)\u000d\u000a     WHERE Id_Ahorro=p_id_meta;\u000d\u000a\u0009\u000d\u000a\u0009--si despues de la actualizacion el monto_ahorrado >= objetivo, forzar estado completed\u000d\u000a\u0009UPDATE META_AHORRO\u000d\u000a    SET Estado='completada'\u000d\u000a    WHERE Id_Ahorro=p_id_meta\u000d\u000a      AND Monto_ahorrado>= Monto_total_alcanzar;\u000d\u000aEND
CREATE PROCEDURE SP_ELIMINAR_META\u000d\u000a(\u000d\u000a\u000d\u000a\u0009IN p_id_meta BIGINT\u000d\u000a\u000d\u000a)\u000d\u000aMODIFIES SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a    DECLARE v_count INT;\u000d\u000a    DECLARE v_monto_ahorrado DECIMAL(14,2);\u000d\u000a\u0009\u000d\u000a\u0009SELECT COUNT(*) INTO v_count FROM META_AHORRO WHERE Id_Ahorro=p_id_meta;\u000d\u000a    IF v_count=0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='La meta indicada no existe';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009SELECT Monto_ahorrado INTO v_monto_ahorrado FROM META_AHORRO WHERE Id_Ahorro = p_id_meta;\u000d\u000a\u0009\u000d\u000a\u0009--para prevenir eliminacion si ya tiene ahorro acumulado (evitar perder historial)\u000d\u000a\u0009 IF v_monto_ahorrado>0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='No se puede eliminar una meta que ya tiene monto ahorrado; cancelela en su lugar';\u000d\u000a     END IF;\u000d\u000a\u0009\u000d\u000a\u0009DELETE FROM META_AHORRO WHERE Id_Ahorro=p_id_meta;\u000d\u000a\u0009\u000d\u000aEND
CREATE FUNCTION SP_CONSULTAR_META(p_id_meta BIGINT)\u000d\u000aRETURNS table\u000d\u000a(\u000d\u000a\u000d\u000a\u0009Id_Ahorro BIGINT,\u000d\u000a    Id_usuario BIGINT,\u000d\u000a    Id_subcategoria BIGINT,\u000d\u000a    Nombre VARCHAR(70),\u000d\u000a    Descripcion_detallada VARCHAR(500),\u000d\u000a    Monto_total_alcanzar DECIMAL(14,2),\u000d\u000a    Monto_ahorrado DECIMAL(14,2),\u000d\u000a    Porcentaje_avance DECIMAL(5,2),\u000d\u000a    Fecha_inicio DATE,\u000d\u000a    Fecha_objetivo DATE,\u000d\u000a    Prioridad VARCHAR(10),\u000d\u000a    Estado VARCHAR(10),\u000d\u000a    creado_en TIMESTAMP,\u000d\u000a    modificado_en TIMESTAMP,\u000d\u000a    creado_por VARCHAR(100),\u000d\u000a    modificado_por VARCHAR(100)\u000d\u000a\u000d\u000a)\u000d\u000aREADS SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a    DECLARE v_count INT;\u000d\u000a    SELECT COUNT(*) INTO v_count FROM META_AHORRO WHERE Id_Ahorro=p_id_meta;\u000d\u000a\u000d\u000a    IF v_count=0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='La meta indicada no existe';\u000d\u000a    END IF;\u000d\u000a    \u000d\u000a    RETURN TABLE\u000d\u000a    (\u000d\u000a    \u000d\u000a    \u0009SELECT\u000d\u000a            Id_Ahorro,\u000d\u000a            Id_usuario,\u000d\u000a            Id_subcategoria,\u000d\u000a            Nombre,\u000d\u000a            Descripcion_detallada,\u000d\u000a            Monto_total_alcanzar,\u000d\u000a            Monto_ahorrado,\u000d\u000a            CASE WHEN Monto_total_alcanzar=0 THEN 0 \u000d\u000a            ELSE round((Monto_ahorrado/Monto_total_alcanzar)*100,2)\u000d\u000a            END AS Porcentaje_avance,\u000d\u000a            Fecha_inicio,\u000d\u000a            Fecha_objetivo,\u000d\u000a            Prioridad,\u000d\u000a            Estado,\u000d\u000a            creado_en,\u000d\u000a            modificado_en,\u000d\u000a            creado_por,\u000d\u000a            modificado_por\u000d\u000a        FROM META_AHORRO\u000d\u000a        WHERE Id_Ahorro=p_id_meta\u000d\u000a        \u000d\u000a    );\u000d\u000a    \u000d\u000aEND
\u000d\u000aCREATE FUNCTION SP_LISTAR_METAS_USUARIO(p_id_usuario BIGINT, p_estado VARCHAR(10))\u000d\u000aRETURNS table\u000d\u000a(\u000d\u000a\u000d\u000a\u0009Id_Ahorro BIGINT,\u000d\u000a    Id_usuario BIGINT,\u000d\u000a    Id_subcategoria BIGINT,\u000d\u000a    Nombre VARCHAR(70),\u000d\u000a    Descripcion_detallada VARCHAR(500),\u000d\u000a    Monto_total_alcanzar DECIMAL(14,2),\u000d\u000a    Monto_ahorrado DECIMAL(14,2),\u000d\u000a    Porcentaje_avance DECIMAL(5,2),\u000d\u000a    Fecha_inicio DATE,\u000d\u000a    Fecha_objetivo DATE,\u000d\u000a    Prioridad VARCHAR(10),\u000d\u000a    Estado VARCHAR(10),\u000d\u000a    creado_en TIMESTAMP,\u000d\u000a    modificado_en TIMESTAMP,\u000d\u000a    creado_por VARCHAR(100),\u000d\u000a    modificado_por VARCHAR(100)\u000d\u000a\u000d\u000a)\u000d\u000aREADS SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a    DECLARE v_count INT;\u000d\u000a    SELECT COUNT(*) INTO v_count FROM USUARIOS WHERE Id_usuario= p_id_usuario;\u000d\u000a    IF v_count=0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='El usuario indicado no existe';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a\u0009RETURN TABLE\u000d\u000a\u0009(\u000d\u000a\u0009\u000d\u000a\u0009\u0009SELECT\u000d\u000a            Id_Ahorro,\u000d\u000a            Id_usuario,\u000d\u000a            Id_subcategoria,\u000d\u000a            Nombre,\u000d\u000a            Descripcion_detallada,\u000d\u000a            Monto_total_alcanzar,\u000d\u000a            Monto_ahorrado,\u000d\u000a            CASE WHEN Monto_total_alcanzar=0 THEN 0 \u000d\u000a            ELSE round((Monto_ahorrado/Monto_total_alcanzar)*100,2)\u000d\u000a            END AS Porcentaje_avance,\u000d\u000a\u0009\u0009\u0009Fecha_inicio,\u000d\u000a            Fecha_objetivo,\u000d\u000a            Prioridad,\u000d\u000a            Estado,\u000d\u000a            creado_en,\u000d\u000a            modificado_en,\u000d\u000a            creado_por,\u000d\u000a            modificado_por\u000d\u000a        FROM META_AHORRO\u000d\u000a        WHERE Id_usuario=p_id_usuario\u000d\u000a          AND(p_estado IS NULL OR Estado=p_estado)\u000d\u000a        ORDER BY creado_en DESC\u000d\u000a        \u000d\u000a    );\u000d\u000a    \u000d\u000aEND
/*C26*/SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
/*C27*/SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
CREATE TRIGGER TG_TRANS_INSERTAR_META\u000d\u000aAFTER INSERT ON TRANSACCION\u000d\u000aREFERENCING NEW ROW AS N\u000d\u000aFOR EACH ROW \u000d\u000aBEGIN ATOMIC \u000d\u000a\u0009IF lower(N.Tipo_de_transaccion)='ahorro'THEN\u000d\u000a\u0009\u0009--sumar monto a meta si existe meta para esa subcategoria y estado en_progreso o pausada (sea criterio)\u000d\u000a\u0009\u0009UPDATE META_AHORRO\u000d\u000a        SET Monto_ahorrado=Monto_ahorrado+N.Monto\u000d\u000a        WHERE Id_subcategoria=N.Id_subcategoria;\u000d\u000a\u0009\u000d\u000a\u0009\u0009--marcar completada si alcanza el objetivo\u000d\u000a\u0009\u0009UPDATE META_AHORRO\u000d\u000a\u0009\u0009SET Estado='Completada'\u000d\u000a\u0009\u0009WHERE Id_subcategoria=N.Id_subcategoria\u000d\u000a          AND Monto_ahorrado>=Monto_total_alcanzar;\u000d\u000a    END IF;\u000d\u000aEND
CREATE TRIGGER TG_TRANS_ACTUALIZAR_META\u000d\u000aAFTER UPDATE ON TRANSACCION\u000d\u000aREFERENCING OLD ROW AS O NEW ROW AS N\u000d\u000aFOR EACH ROW\u000d\u000aBEGIN ATOMIC\u000d\u000a    --si tipo o subcategoria o monto cambio, ajustar\u000d\u000a    IF Lower(O.Tipo_de_transaccion)='ahorro'THEN\u000d\u000a        --restar el monto viejo de su meta (si existe)\u000d\u000a        UPDATE META_AHORRO\u000d\u000a        SET Monto_ahorrado=Monto_ahorrado-O.Monto\u000d\u000a        WHERE Id_subcategoria=O.Id_subcategoria;\u000d\u000a    END IF;\u000d\u000a\u000d\u000a    IF lower(N.Tipo_de_transaccion)='ahorro'THEN\u000d\u000a        -- sumar el monto nuevo a la meta (si existe)\u000d\u000a        UPDATE META_AHORRO\u000d\u000a        SET Monto_ahorrado=Monto_ahorrado+N.Monto\u000d\u000a        WHERE Id_subcategoria=N.Id_subcategoria;\u000d\u000a    END IF;\u000d\u000a\u000d\u000a    --actualizar estados: completar donde corresponda\u000d\u000a    UPDATE META_AHORRO\u000d\u000a    SET Estado='completada'\u000d\u000a    WHERE Monto_ahorrado>=Monto_total_alcanzar;\u000d\u000a\u000d\u000a    --opcional: si una meta quedo con monto_ahorrado < monto_total y estaba completada, devolver a en_progreso\u000d\u000a    UPDATE META_AHORRO\u000d\u000a    SET Estado='en_progreso'\u000d\u000a    WHERE Estado='completada' AND Monto_ahorrado<Monto_total_alcanzar;\u000d\u000aEND
--AFTER DELETE ON TRANSACCION\u000d\u000aCREATE TRIGGER TG_TRANS_BORRAR_META\u000d\u000aAFTER DELETE ON TRANSACCION\u000d\u000aREFERENCING OLD ROW AS O\u000d\u000aFOR EACH ROW\u000d\u000aBEGIN ATOMIC\u000d\u000a    IF lower(O.Tipo_de_transaccion)='ahorro'THEN\u000d\u000a        --restar monto antiguo de la meta si existe\u000d\u000a        UPDATE META_AHORRO\u000d\u000a        SET Monto_ahorrado=Monto_ahorrado-O.Monto\u000d\u000a        WHERE Id_subcategoria=O.Id_subcategoria;\u000d\u000a\u000d\u000a        --si se resto por debajo del objetivo, ajustar estado\u000d\u000a        UPDATE META_AHORRO\u000d\u000a        SET Estado='en_progreso'\u000d\u000a        WHERE Monto_ahorrado<Monto_total_alcanzar;\u000d\u000a    END IF;\u000d\u000aEND
DISCONNECT
/*C25*/INSERT INTO TRANSACCION VALUES(3,1,1,2025,2,1,1,'gasto','Pago alquiler febrero',5000.00,'2025-02-05','transferencia','2025-12-03 00:29:17.693999','2025-12-03 00:29:17.693999',NULL,'royum',NULL)
COMMIT
/*C28*/SET SCHEMA PUBLIC
INSERT INTO CATEGORIA VALUES(6,'Ingresos personale','Mis ingresos guardados','ahorro','2025-12-03 00:36:43.905972',NULL,'royum',NULL)
INSERT INTO SUBCATEGORIA VALUES(6,6,'Subcategor\u00eda por defecto de la categoria','Ingresos personale',TRUE,TRUE,'2025-12-03 00:36:43.905972',NULL,'system',NULL)
COMMIT
DISCONNECT
/*C29*/SET SCHEMA PUBLIC
DELETE FROM SUBCATEGORIA WHERE ID_SUBCATEGORIA=6
INSERT INTO SUBCATEGORIA VALUES(6,6,'Subcategor\u00eda por defecto de la categoria','Ingresos personale',TRUE,FALSE,'2025-12-03 00:36:43.905972',NULL,'system',NULL)
INSERT INTO SUBCATEGORIA VALUES(7,6,'ahorross','ahorros personales',TRUE,TRUE,'2025-12-03 00:38:13.153435',NULL,'royum',NULL)
COMMIT
DISCONNECT
/*C25*/\u000d\u000aALTER TABLE META_AHORRO ALTER COLUMN Estado SET DATA TYPE VARCHAR(20)\u000d\u000a\u0009
ALTER TABLE META_AHORRO DROP CONSTRAINT ck_metas_estado
\u0009\u000d\u000a\u0009ALTER TABLE META_AHORRO\u000d\u000a  ADD CONSTRAINT ck_metas_estado CHECK (Estado IN ('en_progreso','completada','cancelada','pausada'))
INSERT INTO META_AHORRO VALUES(4,2,6,'Ahorro Vacaciones','Ahorro para vacaciones 2025',15000.00,0.00,'2025-01-01','2025-12-31','alta','en_progreso','2025-12-03 00:50:01.035485',NULL,'royum',NULL)
COMMIT
/*C3*/SET SCHEMA PUBLIC
DELETE FROM META_AHORRO WHERE ID_AHORRO=4
COMMIT
/*C25*/INSERT INTO META_AHORRO VALUES(5,2,6,'Ahorro Vacaciones','Ahorro para vacaciones 2025',15000.00,0.00,'2025-01-01','2025-12-31','alta','en_progreso','2025-12-03 00:51:04.095023',NULL,'royum',NULL)
COMMIT
/*C3*/DELETE FROM META_AHORRO WHERE ID_AHORRO=5
COMMIT
/*C25*/INSERT INTO META_AHORRO VALUES(1,2,6,'Ahorro Vacaciones','Ahorro para vacaciones 2025',15000.00,0.00,'2025-01-01','2025-12-31','alta','en_progreso','2025-12-03 00:52:16.544638',NULL,'royum',NULL)
COMMIT
/*C13*/DISCONNECT
/*C26*/DISCONNECT
/*C25*/DISCONNECT
/*C3*/DISCONNECT
/*C24*/DISCONNECT
/*C4*/SET SCHEMA PUBLIC
DISCONNECT
