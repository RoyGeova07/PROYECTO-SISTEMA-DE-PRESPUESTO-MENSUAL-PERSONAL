/*C4*/SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
CREATE PROCEDURE SP_INSERTAR_CATEGORIA\u000d\u000a\u000d\u000a(\u000d\u000a\u000d\u000a    in P_NOMBRE varchar(50),\u000d\u000a    in P_DESCRIPCION varchar(500),\u000d\u000a    in P_TIPO varchar(15),  \u000d\u000a    in P_ID_USUARIO bigint\u000d\u000a\u000d\u000a)\u000d\u000amodifies sql DATA\u000d\u000aBEGIN ATOMIC \u000d\u000a\u0009INSERT INTO CATEGORIA\u000d\u000a\u0009(\u000d\u000a\u0009\u000d\u000a        Nombre,\u000d\u000a        Descripcion_detallada,\u000d\u000a        Tipo_de_categoria,\u000d\u000a        creado_en,\u000d\u000a        creado_por\u000d\u000a        \u000d\u000a    )\u000d\u000a    VALUES\u000d\u000a    (\u000d\u000a    \u000d\u000a        P_NOMBRE,\u000d\u000a        P_DESCRIPCION,\u000d\u000a        LOWER(P_TIPO),      \u000d\u000a        CURRENT_TIMESTAMP,\u000d\u000a        'royum'\u000d\u000a        \u000d\u000a    );\u000d\u000aEND
\u000d\u000acreate procedure SP_ACTUALIZAR_CATEGORIA\u000d\u000a(\u000d\u000a\u000d\u000a    in P_ID_CATEGORIA bigint,\u000d\u000a    in P_NOMBRE varchar(50),\u000d\u000a    in P_DESCRIPCION varchar(500),\u000d\u000a    in P_MODIFICADO_POR varchar(100)\u000d\u000a\u000d\u000a)\u000d\u000amodifies sql data\u000d\u000a    update CATEGORIA\u000d\u000aset Nombre=P_NOMBRE,Descripcion_detallada=P_DESCRIPCION,modificado_en=CURRENT_TIMESTAMP,modificado_por='royum'\u000d\u000awhere Id_categoria=P_ID_CATEGORIA
create procedure SP_ELIMINAR_CATEGORIA\u000d\u000a(\u000d\u000a\u000d\u000a    in P_ID_CATEGORIA bigint\u000d\u000a\u000d\u000a)\u000d\u000amodifies sql DATA\u000d\u000aBEGIN ATOMIC \u000d\u000a\u0009IF exists(SELECT 1 FROM CATEGORIA WHERE Id_categoria=p_id_categoria)THEN\u000d\u000a\u0009\u000d\u000a\u0009\u0009 IF exists(SELECT 1 FROM SUBCATEGORIA WHERE Id_categoria=p_id_Categoria)THEN\u000d\u000a\u0009\u0009 \u0009SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='No se puede eliminar la categoria: tiene subcategorias. Eliminelas o reasignelas primero.';\u000d\u000a        ELSE\u000d\u000a            DELETE FROM CATEGORIA WHERE Id_categoria=p_id_categoria;\u000d\u000a        END IF;\u000d\u000a\u0009ELSE \u000d\u000a\u0009\u0009SIGNAL SQLSTATE '45000'SET message_text='La categoria no existe';\u000d\u000a\u0009END IF;\u000d\u000aEND
\u000d\u000aCREATE FUNCTION SP_CONSULTAR_CATEGORIA(p_id_categoria bigint)\u000d\u000aRETURNS TABLE\u000d\u000a(\u000d\u000a\u000d\u000a\u0009Id_categoria BIGINT,\u000d\u000a    Nombre VARCHAR(50),\u000d\u000a    Descripcion_detallada VARCHAR(500),\u000d\u000a    Tipo_de_categoria VARCHAR(15),\u000d\u000a    creado_en TIMESTAMP,\u000d\u000a    modificado_en TIMESTAMP,\u000d\u000a    creado_por VARCHAR(100),\u000d\u000a    modificado_por VARCHAR(100)\u000d\u000a\u000d\u000a)\u000d\u000aREADS SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a\u0009IF exists(SELECT 1 FROM CATEGORIA WHERE Id_categoria=p_id_categoria)THEN\u000d\u000a\u0009\u0009RETURN TABLE\u000d\u000a\u0009\u0009(\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009\u0009SELECT \u000d\u000a\u0009\u0009\u0009\u0009Id_categoria,\u000d\u000a                Nombre,\u000d\u000a                Descripcion_detallada,\u000d\u000a                Tipo_de_categoria,\u000d\u000a                creado_en,\u000d\u000a                modificado_en,\u000d\u000a                creado_por,\u000d\u000a                modificado_por\u000d\u000a            FROM CATEGORIA\u000d\u000a            WHERE Id_categoria=p_id_categoria\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009);\u000d\u000a\u0009ELSE\u000d\u000a\u0009 SIGNAL SQLSTATE '45000'\u000d\u000a\u0009 \u0009SET message_text='La categoria no existe';\u000d\u000a\u0009END IF;\u000d\u000aEND
/*C5*/SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
DROP PROCEDURE IF EXISTS PUBLIC.SP_INSERTAR_SUBCATEGORIA
DROP PROCEDURE IF EXISTS SP_ACTUALIZAR_SUBCATEGORIA
CREATE PROCEDURE SP_INSERTAR_SUBCATEGORIA\u000d\u000a(\u000d\u000a\u000d\u000a\u0009IN p_id_categoria bigint,\u000d\u000a\u0009IN p_nombre varchar(70),\u000d\u000a\u0009in p_descripcion varchar(500),\u000d\u000a\u0009IN p_es_defecto boolean\u000d\u000a\u0009\u000d\u000a\u000d\u000a)\u000d\u000aMODIFIES SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a\u000d\u000a\u0009--si existe la categoria, se inserta la subcategoria \u000d\u000a\u0009IF exists(SELECT 1 FROM CATEGORIA WHERE Id_categoria=p_id_categoria)THEN\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u000d\u000a\u0009\u0009IF p_es_defecto IS TRUE THEN\u000d\u000a\u0009\u0009\u0009UPDATE SUBCATEGORIA\u000d\u000a\u0009\u0009\u0009SET Por_defecto=FALSE\u000d\u000a\u0009\u0009\u0009WHERE Id_categoria=p_id_categoria AND Por_defecto=true;\u000d\u000a\u0009\u0009END IF;\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009INSERT INTO SUBCATEGORIA\u000d\u000a\u0009\u0009(\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009\u0009Id_categoria,\u000d\u000a            Nombre_subcategoria,\u000d\u000a            Descripcion_detallada,\u000d\u000a            Estado,\u000d\u000a            Por_defecto,\u000d\u000a            creado_en,\u000d\u000a            creado_por\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009)\u000d\u000a\u0009\u0009VALUES\u000d\u000a\u0009\u0009(\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009\u0009p_id_categoria,\u000d\u000a            p_nombre,\u000d\u000a            p_descripcion,\u000d\u000a            TRUE,\u000d\u000a            COALESCE(p_es_defecto, FALSE),\u000d\u000a            CURRENT_TIMESTAMP,\u000d\u000a            'royum'\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009);\u000d\u000a\u0009ELSE \u000d\u000a\u0009\u0009SIGNAL SQLSTATE'45000'SET message_text='La categoria indicada no existe';\u000d\u000a\u0009END IF;\u000d\u000aEND
CREATE PROCEDURE SP_ACTUALIZAR_SUBCATEGORIA\u000d\u000a(\u000d\u000a\u000d\u000a\u0009IN p_id_subcategoria bigint,\u000d\u000a\u0009IN p_nombre varchar(70),\u000d\u000a\u0009IN p_descripcion varchar(500),\u000d\u000a\u0009IN p_es_defecto boolean\u000d\u000a\u000d\u000a)\u000d\u000aMODIFIES SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a\u0009DECLARE v_id_categoria BIGINT;\u000d\u000a\u0009IF exists(SELECT 1 FROM SUBCATEGORIA WHERE Id_subcategoria=p_id_subcategoria)THEN\u000d\u000a\u0009\u000d\u000a\u0009\u0009IF p_es_defecto IS TRUE THEN\u000d\u000a\u0009\u0009\u0009  \u000d\u000a    \u0009    SELECT Id_categoria INTO v_id_categoria FROM SUBCATEGORIA WHERE Id_subcategoria=p_id_subcategoria;\u000d\u000a\u000d\u000a\u0009        UPDATE SUBCATEGORIA\u000d\u000a\u0009        SET Por_defecto=FALSE\u000d\u000a    \u0009    WHERE Id_categoria=v_id_categoria AND Por_defecto=TRUE;\u000d\u000a\u0009    END IF;\u000d\u000a\u0009\u000d\u000a\u0009\u0009UPDATE SUBCATEGORIA\u000d\u000a\u0009\u0009SET Nombre_subcategoria=p_nombre,\u000d\u000a\u0009\u0009\u0009Descripcion_detallada=p_descripcion,\u000d\u000a\u0009\u0009\u0009por_defecto=coalesce(p_es_defecto,por_defecto),\u000d\u000a            modificado_por='royum',\u000d\u000a            modificado_en=CURRENT_TIMESTAMP\u000d\u000a        WHERE Id_subcategoria=p_id_subcategoria;\u000d\u000a\u0009ELSE \u000d\u000a\u0009\u0009SIGNAL SQLSTATE'45000'SET message_text='la subcategoria indicada no existe';\u000d\u000a\u0009END IF;\u000d\u000aEND
/*C6*/SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
DROP PROCEDURE IF EXISTS SP_INSERTAR_PRESUPUESTO
DROP PROCEDURE IF EXISTS SP_ACTUALIZAR_PRESUPUESTO
CREATE PROCEDURE SP_INSERTAR_PRESUPUESTO\u000d\u000a(\u000d\u000a\u000d\u000a\u0009IN p_id_usuario bigint,\u000d\u000a\u0009IN p_nombre_descriptivo varchar(500),\u000d\u000a    IN p_anio_inicio SMALLINT,\u000d\u000a    IN p_mes_inicio TINYINT,\u000d\u000a    IN p_anio_fin SMALLINT,\u000d\u000a    IN p_mes_fin TINYINT,\u000d\u000a    IN p_total_ingresos decimal(14,2),\u000d\u000a    IN p_total_gastos decimal(14,2),\u000d\u000a    IN p_total_ahorro decimal(14,2)\u000d\u000a\u000d\u000a)\u000d\u000aMODIFIES SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a\u0009\u000d\u000a\u0009--primero hare la validacion de vigencia\u000d\u000a\u0009IF not((p_anio_fin>p_anio_inicio)OR(p_anio_fin=p_anio_inicio AND p_mes_fin>=p_mes_inicio))THEN\u000d\u000a\u0009\u0009SIGNAL SQLSTATE'45000' SET message_text='Periodo invalido: fecha fin debe ser igual o posterior a fecha inicio';\u000d\u000a\u0009END IF;\u000d\u000a\u0009\u000d\u000a\u0009\u000d\u000a\u0009--luego se valida que no exista otro presupuesto activo del mismo usuario que se solape\u000d\u000a\u0009 IF exists(SELECT 1 FROM PRESUPUESTO pr\u000d\u000a        WHERE pr.Id_usuario=p_id_usuario\u000d\u000a          AND pr.Estado_presupuesto='activo'\u000d\u000a          AND NOT(\u000d\u000a              (pr.Anio_de_fin<p_anio_inicio)\u000d\u000a              OR(pr.Anio_de_fin=p_anio_inicio AND pr.Mes_de_fin<p_mes_inicio)\u000d\u000a              OR(pr.Anio_de_inicio>p_anio_fin)\u000d\u000a              OR(pr.Anio_de_inicio=p_anio_fin AND pr.Mes_de_inicio>p_mes_fin)))THEN\u000d\u000a        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Ya existe un presupuesto activo para el usuario en un periodo solapado';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009--otra validacion que me da pereza poner, seria lo de validar montos, osea El total de ingresos debe ser mayor o igual a la suma de gastos y ahorro'\u000d\u000a\u0009--que se hagan mejor en el front foc\u000d\u000a\u0009\u000d\u000a\u0009INSERT INTO PRESUPUESTO\u000d\u000a\u0009(\u000d\u000a\u0009\u000d\u000a\u0009\u0009Id_usuario,\u000d\u000a        Nombre_descriptivo,\u000d\u000a        Anio_de_inicio,\u000d\u000a        Mes_de_inicio,\u000d\u000a        Anio_de_fin,\u000d\u000a        Mes_de_fin,\u000d\u000a        Total_de_ingresos,\u000d\u000a        Total_de_gastos,\u000d\u000a        Total_de_ahorro,\u000d\u000a        Fecha_hora_creacion,\u000d\u000a        Estado_presupuesto,\u000d\u000a        creado_en,\u000d\u000a        creado_por\u000d\u000a\u0009\u000d\u000a\u0009)values(\u000d\u000a\u0009\u000d\u000a\u0009\u0009p_id_usuario,\u000d\u000a        p_nombre_descriptivo,\u000d\u000a        p_anio_inicio,\u000d\u000a        p_mes_inicio,\u000d\u000a        p_anio_fin,\u000d\u000a        p_mes_fin,\u000d\u000a        p_total_ingresos,\u000d\u000a        p_total_gastos,\u000d\u000a        p_total_ahorro,\u000d\u000a        CURRENT_TIMESTAMP,\u000d\u000a        'activo',\u000d\u000a        CURRENT_TIMESTAMP,\u000d\u000a        'royum'\u000d\u000a\u0009\u000d\u000a\u0009);\u000d\u000aEND
CREATE PROCEDURE SP_ACTUALIZAR_PRESUPUESTO\u000d\u000a(\u000d\u000a\u0009\u000d\u000a\u0009IN p_id_presupuesto bigint,\u000d\u000a    IN p_nombre_descriptivo varchar(500),\u000d\u000a    IN p_anio_inicio SMALLINT,\u000d\u000a    IN p_mes_inicio TINYINT,\u000d\u000a    IN p_anio_fin SMALLINT,\u000d\u000a    IN p_mes_fin TINYINT,\u000d\u000a    IN p_total_ingresos decimal(14,2),\u000d\u000a    IN p_total_gastos decimal(14,2),\u000d\u000a    IN p_total_ahorro decimal(14,2),\u000d\u000a    IN p_modificado_por varchar(100)\u0009\u000d\u000a\u000d\u000a)\u000d\u000aMODIFIES SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a\u0009\u000d\u000a\u0009--se verifica si existe el presupuesto\u000d\u000a\u0009DECLARE v_count int;\u000d\u000a\u0009DECLARE v_id_usuario bigint;\u000d\u000a\u0009SELECT count(*) INTO v_count FROM PRESUPUESTO WHERE Id_presupuesto=p_id_presupuesto;\u000d\u000a\u0009IF v_count=0 then\u000d\u000a\u0009\u0009SIGNAL SQLSTATE '45000'SET message_text='El presupuesto indicado no existe';\u000d\u000a\u0009END IF;\u000d\u000a\u0009\u000d\u000a\u0009SELECT Id_usuario INTO v_id_usuario\u000d\u000a\u0009FROM PRESUPUESTO\u000d\u000a\u0009WHERE Id_presupuesto=p_id_presupuesto;\u000d\u000a\u0009\u000d\u000a\u0009--se valida la vigencia \u000d\u000a\u0009IF NOT((p_anio_fin>p_anio_inicio)OR(p_anio_fin=p_anio_inicio AND p_mes_fin>=p_mes_inicio))THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='Periodo invalido: fecha fin debe ser igual o posterior a fecha inicio';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a\u0009--se valida que no exista otro presupuesto activo del mismo usuario q solape \u000d\u000a\u0009 IF EXISTS(SELECT 1 FROM PRESUPUESTO pr\u000d\u000a        WHERE pr.Id_usuario=v_id_usuario\u000d\u000a          AND pr.Estado_presupuesto='activo'\u000d\u000a          AND pr.Id_presupuesto<>p_id_presupuesto\u000d\u000a          AND NOT((pr.Anio_de_fin<p_anio_inicio)OR(pr.Anio_de_fin=p_anio_inicio AND pr.Mes_de_fin<p_mes_inicio)OR(pr.Anio_de_inicio>p_anio_fin)\u000d\u000a              OR(pr.Anio_de_inicio=p_anio_fin AND pr.Mes_de_inicio>p_mes_fin)))THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='Ya existe un presupuesto activo del usuario que solapa el periodo solicitado';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009--ahora si actualizar \u000d\u000a\u0009UPDATE PRESUPUESTO\u000d\u000a\u0009SET Nombre_descriptivo=p_nombre_descriptivo,\u000d\u000a        Anio_de_inicio=p_anio_inicio,\u000d\u000a        Mes_de_inicio=p_mes_inicio,\u000d\u000a        Anio_de_fin=p_anio_fin,\u000d\u000a        Mes_de_fin=p_mes_fin,\u000d\u000a        Total_de_ingresos=p_total_ingresos,\u000d\u000a        Total_de_gastos=p_total_gastos,\u000d\u000a        Total_de_ahorro=p_total_ahorro,\u000d\u000a        modificado_en=CURRENT_TIMESTAMP,\u000d\u000a        modificado_por='royum'\u000d\u000a    WHERE Id_presupuesto=p_id_presupuesto;\u000d\u000a\u0009\u000d\u000aEND
/*C7*/SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
DROP PROCEDURE IF EXISTS SP_INSERTAR_PRESUPUESTO_DETALLE
DROP PROCEDURE IF EXISTS SP_ACTUALIZAR_PRESUPUESTO_DETALLE
CREATE PROCEDURE SP_INSERTAR_PRESUPUESTO_DETALLE\u000d\u000a(\u000d\u000a\u000d\u000a\u0009IN p_id_presupuesto bigint,\u000d\u000a    IN p_id_subcategoria bigint,\u000d\u000a    IN p_monto_mensual decimal(14,2),\u000d\u000a    IN p_justificacion varchar(500)\u000d\u000a\u000d\u000a)\u000d\u000aMODIFIES SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a\u0009 DECLARE v_count int;\u000d\u000a\u0009--validar primero que el presupuesto exista\u000d\u000a\u0009SELECT count(*)into v_count FROM PRESUPUESTO WHERE Id_presupuesto=p_id_presupuesto;\u000d\u000a\u0009IF v_count=0 THEN\u000d\u000a\u0009\u0009  SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='El presupuesto indicado no existe';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a\u0009--ahora validar la subcategoria\u000d\u000a\u0009SELECT count(*)into v_count FROM SUBCATEGORIA WHERE Id_subcategoria=p_id_subcategoria;\u000d\u000a\u0009IF v_count=0 THEN\u000d\u000a\u0009\u0009  SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='La subcategoria indicada no existe';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009--y por ultimo validar que no exista ya detalle para la misma subcategoria en ese presupuesto\u000d\u000a\u0009SELECT count(*)into v_count FROM PRESUPUESTO_DETALLE WHERE Id_presupuesto=p_id_presupuesto AND Id_subcategoria=p_id_subcategoria;\u000d\u000a\u0009IF v_count>0 then\u000d\u000a\u0009\u0009SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='Ya existe un detalle para esa subcategoria en el presupuesto';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009--ahora por las dudas monto no negativo\u000d\u000a\u0009IF p_monto_mensual<0 THEN\u000d\u000a\u0009\u0009SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT='El monto mensual no puede ser negativo';\u000d\u000a\u0009END IF;\u000d\u000a\u0009\u000d\u000a\u0009INSERT INTO PRESUPUESTO_DETALLE\u000d\u000a\u0009(\u000d\u000a\u0009\u000d\u000a\u0009\u0009Id_presupuesto,\u000d\u000a        Id_subcategoria,\u000d\u000a        Monto_mensual,\u000d\u000a        Justificacion_del_monto,\u000d\u000a        creado_en,\u000d\u000a        creado_por\u000d\u000a\u0009\u000d\u000a\u0009)values(\u000d\u000a\u0009\u000d\u000a\u0009\u0009p_id_presupuesto,\u000d\u000a        p_id_subcategoria,\u000d\u000a        p_monto_mensual,\u000d\u000a        p_justificacion,\u000d\u000a        CURRENT_TIMESTAMP,\u000d\u000a        'royum'\u000d\u000a\u0009\u000d\u000a\u0009);\u000d\u000aEND
CREATE PROCEDURE SP_ACTUALIZAR_PRESUPUESTO_DETALLE\u000d\u000a(\u000d\u000a\u000d\u000a\u0009IN p_id_detalle bigint,\u000d\u000a    IN p_monto_mensual decimal(14,2),\u000d\u000a    IN p_justificacion varchar(500)\u000d\u000a\u000d\u000a)\u000d\u000aMODIFIES SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a\u0009DECLARE v_count INT;\u000d\u000a\u0009SELECT count(*) INTO v_count FROM PRESUPUESTO_DETALLE WHERE Id_presupuesto_detalle=p_id_detalle;\u000d\u000a\u0009 IF v_count=0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='El detalle de presupuesto no existe';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a\u0009IF p_monto_mensual<0 THEN\u000d\u000a\u0009\u0009SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT='El monto mensual no puede ser negativo';\u000d\u000a\u0009END IF;\u000d\u000a\u0009\u000d\u000a\u0009UPDATE PRESUPUESTO_DETALLE\u000d\u000a\u0009SET Monto_mensual=p_monto_mensual,\u000d\u000a\u0009\u0009Justificacion_del_monto=p_justificacion,\u000d\u000a        modificado_en=CURRENT_TIMESTAMP,\u000d\u000a        modificado_por='royum'\u000d\u000a    WHERE Id_presupuesto_detalle=p_id_detalle;\u000d\u000aEND
/*C8*/SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
DROP PROCEDURE IF EXISTS SP_INSERTAR_OBLIGACION
DROP PROCEDURE IF EXISTS SP_ACTUALIZAR_OBLIGACION
CREATE PROCEDURE SP_INSERTAR_OBLIGACION\u000d\u000a(\u000d\u000a\u000d\u000a\u0009IN p_id_usuario BIGINT,\u000d\u000a    IN p_id_subcategoria BIGINT,\u000d\u000a    IN p_nombre VARCHAR(70),\u000d\u000a    IN p_descripcion VARCHAR(500),\u000d\u000a    IN p_monto DECIMAL(14,2),\u000d\u000a    IN p_dia_vencimiento SMALLINT,\u000d\u000a    IN p_fecha_inicio DATE,\u000d\u000a    IN p_fecha_fin DATE\u000d\u000a\u000d\u000a)\u000d\u000aMODIFIES SQL DATA\u000d\u000aBEGIN ATOMIC \u000d\u000a\u0009DECLARE v_count INT;\u000d\u000a    DECLARE v_tipo_categoria VARCHAR(15);\u000d\u000a\u0009 SELECT COUNT(*) INTO v_count FROM USUARIOS WHERE Id_usuario=p_id_usuario;\u000d\u000a    IF v_count=0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='El usuario indicado no existe';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a\u0009--validar q la subcategoria existe  y obtener tipo de categoria usando join\u000d\u000a\u0009SELECT c.Tipo_de_categoria INTO v_tipo_categoria\u000d\u000a    FROM SUBCATEGORIA s\u000d\u000a    LEFT JOIN CATEGORIA c ON c.Id_categoria=s.Id_categoria\u000d\u000a    WHERE s.Id_subcategoria=p_id_subcategoria;\u000d\u000a\u0009\u000d\u000a\u0009 IF v_tipo_categoria IS NULL THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='La subcategoria indicada no existe';\u000d\u000a    END IF;\u000d\u000a\u0009 \u000d\u000a\u0009 --ahora validar que la subcategoria sea de tipo gasto\u000d\u000a\u0009 IF lower(v_tipo_categoria)<>'gasto'THEN\u000d\u000a\u0009 \u0009 SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='La subcategoroa asociada debe ser de tipo ''gasto'' para una obligacion fija';\u000d\u000a\u0009 END IF;\u000d\u000a\u0009 \u000d\u000a\u0009 --validar dia de vencimiento \u000d\u000a\u0009 IF p_dia_vencimiento<1 OR p_dia_vencimiento>31 THEN\u000d\u000a\u0009 \u0009 SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='El d\u00eda de vencimiento debe estar entre 1 y 31';\u000d\u000a     END IF;\u000d\u000a\u0009 \u000d\u000a\u0009 --validar fechas, si fecha_fin no es null debe ser mayor que fecha_inicio\u000d\u000a\u0009 IF p_fecha_fin IS NOT NULL THEN\u000d\u000a        IF p_fecha_fin<=p_fecha_inicio THEN\u000d\u000a            SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='La fecha de finalizacion debe ser posterior a la fecha de inicio';\u000d\u000a        END IF;\u000d\u000a     END IF;\u000d\u000a\u0009 \u000d\u000a\u0009 IF p_monto<0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT='El monto no puede ser negativo';\u000d\u000a     END IF;\u000d\u000a\u0009 \u000d\u000a\u0009 --validar unicidaddd\u000d\u000a\u0009 SELECT count(*)INTO v_count FROM OBLIGACION_FIJA WHERE Id_subcategoria=p_id_subcategoria;\u000d\u000a\u0009  IF v_count>0 THEN\u000d\u000a        SIGNAL SQLSTATE'45000'SET MESSAGE_TEXT='Ya existe una obligacion asociada a esa subcategoria';\u000d\u000a      END IF;\u000d\u000a\u0009 \u000d\u000a\u0009 INSERT INTO OBLIGACION_FIJA\u000d\u000a\u0009 (\u000d\u000a\u0009 \u000d\u000a\u0009 \u0009Id_usuario,\u000d\u000a        Id_subcategoria,\u000d\u000a        Nombre,\u000d\u000a        Descripcion_detallada,\u000d\u000a        Monto_fijo_mensual,\u000d\u000a        Dia_del_mes_de_vencimiento,\u000d\u000a        Esta_vigente,\u000d\u000a        Fecha_inicio_de_la_obligacion,\u000d\u000a        Fecha_de_finalizacion,\u000d\u000a        creado_en,\u000d\u000a        creado_por\u000d\u000a\u0009 \u000d\u000a\u0009 )values(\u000d\u000a\u0009 \u000d\u000a\u0009 \u0009 p_id_usuario,\u000d\u000a        p_id_subcategoria,\u000d\u000a        p_nombre,\u000d\u000a        p_descripcion,\u000d\u000a        p_monto,\u000d\u000a        p_dia_vencimiento,\u000d\u000a        TRUE,\u000d\u000a        p_fecha_inicio,\u000d\u000a        p_fecha_fin,\u000d\u000a        CURRENT_TIMESTAMP,\u000d\u000a        'royum'\u000d\u000a\u0009 \u000d\u000a\u0009 );\u000d\u000aEND
CREATE PROCEDURE SP_ACTUALIZAR_OBLIGACION\u000d\u000a(\u000d\u000a\u000d\u000a\u0009IN p_id_obligacion BIGINT,\u000d\u000a    IN p_nombre VARCHAR(70),\u000d\u000a    IN p_descripcion VARCHAR(500),\u000d\u000a    IN p_monto DECIMAL(14,2),\u000d\u000a    IN p_dia_vencimiento SMALLINT,\u000d\u000a    IN p_fecha_fin DATE,\u000d\u000a    IN p_activo BOOLEAN,\u000d\u000a    IN p_modificado_por VARCHAR(100)\u000d\u000a\u000d\u000a)\u000d\u000aMODIFIES SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a    DECLARE v_count INT;\u000d\u000a\u0009DECLARE v_fecha_inicio DATE;\u000d\u000a\u0009 SELECT COUNT(*) INTO v_count FROM OBLIGACION_FIJA WHERE Id_obligacion_fija=p_id_obligacion;\u000d\u000a    IF v_count=0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='La obligacion indicada no existe';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a\u0009IF p_monto<0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='El monto no puede ser negativo';\u000d\u000a    END IF;\u000d\u000a    IF p_dia_vencimiento<1 OR p_dia_vencimiento>31 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='El d\u00eda de vencimiento debe estar entre 1 y 31';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009--si fecha_fin no es null, obtener fecha_inicio para comparar\u000d\u000a\u0009IF p_fecha_fin IS NOT NULL THEN\u000d\u000a        SELECT Fecha_inicio_de_la_obligacion INTO v_fecha_inicio FROM OBLIGACION_FIJA WHERE Id_obligacion_fija=p_id_obligacion;\u000d\u000a        IF p_fecha_fin<=v_fecha_inicio THEN\u000d\u000a            SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='La fecha de finalizacion debe ser posterior a la fecha de inicio';\u000d\u000a        END IF;\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009UPDATE OBLIGACION_FIJA\u000d\u000a    SET Nombre=p_nombre,\u000d\u000a        Descripcion_detallada=p_descripcion,\u000d\u000a        Monto_fijo_mensual=p_monto,\u000d\u000a        Dia_del_mes_de_vencimiento=p_dia_vencimiento,\u000d\u000a        Fecha_de_finalizacion=p_fecha_fin,\u000d\u000a        Esta_vigente=COALESCE(p_activo, Esta_vigente),\u000d\u000a        modificado_en=CURRENT_TIMESTAMP,\u000d\u000a        modificado_por='royum'\u000d\u000a    WHERE Id_obligacion_fija=p_id_obligacion;\u000d\u000aEND
/*C9*/SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
DROP PROCEDURE IF EXISTS SP_INSERTAR_TRANSACCION
DROP PROCEDURE IF EXISTS SP_ACTUALIZAR_TRANSACCION
CREATE PROCEDURE SP_INSERTAR_TRANSACCION\u000d\u000a(\u000d\u000a\u000d\u000a\u0009IN p_id_usuario BIGINT,\u000d\u000a    IN p_id_presupuesto BIGINT,\u000d\u000a    IN p_anio SMALLINT,\u000d\u000a    IN p_mes SMALLINT,\u000d\u000a    IN p_id_subcategoria BIGINT,\u000d\u000a    IN p_id_obligacion BIGINT,--nullable\u000d\u000a    IN p_tipo VARCHAR(15),\u000d\u000a    IN p_descripcion VARCHAR(500),\u000d\u000a    IN p_monto DECIMAL(14,2),\u000d\u000a    IN p_fecha DATE,\u000d\u000a    IN p_metodo_pago VARCHAR(30)\u000d\u000a    \u000d\u000a\u000d\u000a)\u000d\u000aMODIFIES SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a    DECLARE v_count INT;\u000d\u000a    DECLARE v_tipo_categoria VARCHAR(15);\u000d\u000a    DECLARE v_presu_anio SMALLINT;\u000d\u000a    DECLARE v_presu_mes SMALLINT;\u000d\u000a    DECLARE v_presu_anio_fin SMALLINT;\u000d\u000a    DECLARE v_presu_mes_fin SMALLINT;\u000d\u000a\u000d\u000a    \u000d\u000a    SELECT COUNT(*)INTO v_count FROM USUARIOS WHERE Id_usuario=p_id_usuario;\u000d\u000a    IF v_count=0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT ='Usuario no existe';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a    \u000d\u000a    SELECT COUNT(*)INTO v_count FROM PRESUPUESTO WHERE Id_presupuesto =p_id_presupuesto;\u000d\u000a    IF v_count =0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT ='Presupuesto no existe';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a    --validar subcategoria y obtener tipo de categoria padre\u000d\u000a    SELECT c.Tipo_de_categoria\u000d\u000a      INTO v_tipo_categoria\u000d\u000a      FROM SUBCATEGORIA s\u000d\u000a      LEFT JOIN CATEGORIA c ON c.Id_categoria =s.Id_categoria\u000d\u000a     WHERE s.Id_subcategoria= p_id_subcategoria;\u000d\u000a\u000d\u000a    IF v_tipo_categoria IS NULL THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='Subcategoria no existe';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a    --validar que p_tipo coincide con tipo de categoria padre\u000d\u000a    IF  lower(p_tipo)<>lower(v_tipo_categoria) THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='Tipo de transaccion no coincide con tipo de la categoria padre';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a    --si viene id_obligacion, validar que existe y que usa la misma subcategoria\u000d\u000a    IF p_id_obligacion IS NOT NULL THEN\u000d\u000a        SELECT COUNT(*) INTO v_count FROM OBLIGACION_FIJA WHERE Id_obligacion_fija=p_id_obligacion;\u000d\u000a        IF v_count=0 THEN\u000d\u000a            SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='Obligacion indicada no existe';\u000d\u000a        END IF;\u000d\u000a\u000d\u000a        SELECT COUNT(*)INTO v_count\u000d\u000a        FROM OBLIGACION_FIJA\u000d\u000a        WHERE Id_obligacion_fija=p_id_obligacion\u000d\u000a          AND Id_subcategoria =p_id_subcategoria;\u000d\u000a\u000d\u000a        IF v_count=0 THEN\u000d\u000a            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT='La obligacion no corresponde a la subcategoria indicada';\u000d\u000a        END IF;\u000d\u000a    END IF;\u000d\u000a\u000d\u000a    \u000d\u000a    IF p_monto<0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='El monto no puede ser negativo';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a    IF p_mes<1 OR p_mes>12 THEN\u000d\u000a        SIGNAL SQLSTATE'45000'SET MESSAGE_TEXT ='Mes invalido (1..12)';\u000d\u000a    END IF;\u000d\u000a\u000d\u000a    --validar vigencia del presupuesto (obtener periodos)\u000d\u000a    SELECT Anio_de_inicio,Mes_de_inicio,Anio_de_fin,Mes_de_fin\u000d\u000a      INTO v_presu_anio,v_presu_mes,v_presu_anio_fin,v_presu_mes_fin\u000d\u000a    FROM PRESUPUESTO\u000d\u000a    WHERE Id_presupuesto= p_id_presupuesto;\u000d\u000a\u000d\u000a    IF NOT((p_anio>v_presu_anio OR(p_anio= v_presu_anio AND p_mes >=v_presu_mes))AND\u000d\u000a        (p_anio<v_presu_anio_fin OR(p_anio=v_presu_anio_fin AND p_mes<=v_presu_mes_fin)))THEN\u000d\u000a        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT ='A\u00f1o/Mes fuera del periodo de vigencia del presupuesto';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009--ahora si insertar\u000d\u000a\u0009INSERT INTO TRANSACCION\u000d\u000a\u0009(\u000d\u000a\u0009\u000d\u000a\u0009\u0009Id_usuario,\u000d\u000a        Id_presupuesto,\u000d\u000a        Anio,\u000d\u000a        Mes,\u000d\u000a        Id_subcategoria,\u000d\u000a        Id_obligacion_fija,\u000d\u000a        Tipo_de_transaccion,\u000d\u000a        Descripcion,\u000d\u000a        Monto,\u000d\u000a        Fecha,\u000d\u000a        Metodo_de_pago,\u000d\u000a        Fecha_hora_de_registro,\u000d\u000a        creado_en,\u000d\u000a        creado_por\u000d\u000a\u0009\u000d\u000a\u0009)values(\u000d\u000a\u0009\u000d\u000a\u0009\u0009p_id_usuario,\u000d\u000a        p_id_presupuesto,\u000d\u000a        p_anio,\u000d\u000a        p_mes,\u000d\u000a        p_id_subcategoria,\u000d\u000a        p_id_obligacion,\u000d\u000a        LOWER(p_tipo),\u000d\u000a        p_descripcion,\u000d\u000a        p_monto,\u000d\u000a        p_fecha,\u000d\u000a        LOWER(p_metodo_pago),\u000d\u000a        CURRENT_TIMESTAMP,\u000d\u000a        CURRENT_TIMESTAMP,\u000d\u000a        'royum'\u000d\u000a\u0009\u000d\u000a\u0009);\u000d\u000aEND
CREATE PROCEDURE SP_ACTUALIZAR_TRANSACCION\u000d\u000a(\u000d\u000a\u000d\u000a\u0009IN p_id_transaccion BIGINT,\u000d\u000a    IN p_anio SMALLINT,\u000d\u000a    IN p_mes SMALLINT,\u000d\u000a    IN p_descripcion VARCHAR(500),\u000d\u000a    IN p_monto DECIMAL(14,2),\u000d\u000a    IN p_fecha DATE,\u000d\u000a    IN p_metodo_pago VARCHAR(30),\u000d\u000a    IN p_modificado_por VARCHAR(100)\u000d\u000a\u000d\u000a)\u000d\u000aMODIFIES SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a    DECLARE v_count INT;\u000d\u000a    DECLARE v_presu_id BIGINT;\u000d\u000a    DECLARE v_presu_anio SMALLINT;\u000d\u000a    DECLARE v_presu_mes SMALLINT;\u000d\u000a    DECLARE v_presu_anio_fin SMALLINT;\u000d\u000a    DECLARE v_presu_mes_fin SMALLINT;\u000d\u000a\u000d\u000a\u0009SELECT COUNT(*) INTO v_count FROM TRANSACCION WHERE Id_transaccion=p_id_transaccion;\u000d\u000a    IF v_count =0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='Transacci\u00f3n no existe';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009--aqui obtengo el presupuesto asociado\u000d\u000a\u0009SELECT Id_presupuesto INTO v_presu_id FROM TRANSACCION WHERE Id_transaccion=p_id_transaccion;\u000d\u000a\u0009\u000d\u000a\u0009IF p_monto<0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='El monto no puede ser negativo';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a    IF p_mes<1 OR p_mes>12 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='Mes invalido (1..12)';\u000d\u000a    END IF;\u000d\u000a    \u000d\u000a    --validar que p_anio/p_mes estn dentro de vigencia del presupuesto\u000d\u000a     SELECT Anio_de_inicio,Mes_de_inicio,Anio_de_fin,Mes_de_fin\u000d\u000a      INTO v_presu_anio,v_presu_mes,v_presu_anio_fin,v_presu_mes_fin\u000d\u000a    FROM PRESUPUESTO\u000d\u000a    WHERE Id_presupuesto=v_presu_id;\u000d\u000a    \u000d\u000a    IF NOT((p_anio>v_presu_anio OR(p_anio= v_presu_anio AND p_mes >=v_presu_mes))AND\u000d\u000a        (p_anio<v_presu_anio_fin OR(p_anio=v_presu_anio_fin AND p_mes<=v_presu_mes_fin)))THEN\u000d\u000a        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT ='A\u00f1o/Mes fuera del periodo de vigencia del presupuesto';\u000d\u000a    END IF;\u000d\u000a    \u000d\u000a    --ahora si actualizar\u000d\u000a     UPDATE TRANSACCION\u000d\u000a     SET Anio=p_anio,\u000d\u000a        Mes=p_mes,\u000d\u000a        Descripcion=p_descripcion,\u000d\u000a        Monto=p_monto,\u000d\u000a        Fecha=p_fecha,\u000d\u000a        Metodo_de_pago=LOWER(p_metodo_pago),\u000d\u000a        modificado_en=CURRENT_TIMESTAMP,\u000d\u000a        modificado_por='royum'\u000d\u000a    WHERE Id_transaccion=p_id_transaccion;\u000d\u000aEND
/*C10*/SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
DROP PROCEDURE IF EXISTS SP_INSERTAR_META
DROP PROCEDURE IF EXISTS SP_ACTUALIZAR_META
CREATE PROCEDURE SP_INSERTAR_META\u000d\u000a(\u000d\u000a\u000d\u000a\u0009IN p_id_usuario BIGINT,\u000d\u000a    IN p_id_subcategoria BIGINT,\u000d\u000a    IN p_nombre VARCHAR(70),\u000d\u000a    IN p_descripcion VARCHAR(500),\u000d\u000a    IN p_monto_objetivo DECIMAL(14,2),\u000d\u000a    IN p_fecha_inicio DATE,\u000d\u000a    IN p_fecha_objetivo DATE,\u000d\u000a    IN p_prioridad VARCHAR(10)\u000d\u000a\u000d\u000a)\u000d\u000aMODIFIES SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a    DECLARE v_count INT;\u000d\u000a    DECLARE v_tipo_categoria VARCHAR(15);\u000d\u000a\u000d\u000a\u0009SELECT COUNT(*) INTO v_count FROM USUARIOS WHERE Id_usuario=p_id_usuario;\u000d\u000a    IF v_count =0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='El usuario indicado no existe';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009--validar subcategoria existe y es de tipo ahorro\u000d\u000a\u0009SELECT c.Tipo_de_categoria INTO v_tipo_categoria\u000d\u000a\u0009FROM SUBCATEGORIA s\u000d\u000a\u0009LEFT JOIN CATEGORIA c ON c.Id_categoria=s.Id_categoria\u000d\u000a\u0009WHERE s.Id_subcategoria=p_id_subcategoria;\u000d\u000a\u0009\u000d\u000a\u0009IF v_tipo_categoria IS NULL THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='La subcategoria indicada no existe';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009IF lower(v_tipo_categoria)<>'ahorro'THEN\u000d\u000a\u0009\u0009  SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'La subcategoria debe ser de tipo ''ahorro''';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009IF p_fecha_objetivo<=p_fecha_inicio THEN\u000d\u000a        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT='La fecha objetivo debe ser posterior a la fecha de inicio';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009IF p_monto_objetivo<0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='El monto objetivo debe ser mayor o igual a 0';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009--asegurar que no exista ya una meta ACTIVA/en_progreso para esa subcategoria\u000d\u000a\u0009IF exists(SELECT 1 FROM META_AHORRO m\u000d\u000a\u0009WHERE m.Id_subcategoria=p_id_subcategoria AND m.Estado='en_progreso')then\u000d\u000a\u0009\u0009SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Ya existe una meta activa para esa subcategor\u00eda';\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009\u000d\u000a\u0009INSERT INTO META_AHORRO\u000d\u000a\u0009(\u000d\u000a\u0009\u000d\u000a\u0009\u0009Id_usuario,\u000d\u000a        Id_subcategoria,\u000d\u000a        Nombre,\u000d\u000a        Descripcion_detallada,\u000d\u000a        Monto_total_alcanzar,\u000d\u000a        Monto_ahorrado,\u000d\u000a        Fecha_inicio,\u000d\u000a        Fecha_objetivo,\u000d\u000a        Prioridad,\u000d\u000a        Estado,\u000d\u000a        creado_en,\u000d\u000a        creado_por\u000d\u000a\u0009\u000d\u000a\u0009)values(\u000d\u000a\u0009\u000d\u000a\u0009\u0009p_id_usuario,\u000d\u000a        p_id_subcategoria,\u000d\u000a        p_nombre,\u000d\u000a        p_descripcion,\u000d\u000a        p_monto_objetivo,\u000d\u000a        0.00,--inicio con 0 ahorrado\u000d\u000a        p_fecha_inicio,\u000d\u000a        p_fecha_objetivo,\u000d\u000a        LOWER(COALESCE(p_prioridad,'media')),\u000d\u000a        'en_progreso',--al crear queda en_progreso por defecto\u000d\u000a        CURRENT_TIMESTAMP,\u000d\u000a        'royum'\u000d\u000a        \u000d\u000a    );\u000d\u000aEND
CREATE PROCEDURE SP_ACTUALIZAR_META\u000d\u000a(\u000d\u000a\u000d\u000a\u0009IN p_id_meta BIGINT,\u000d\u000a    IN p_nombre VARCHAR(70),\u000d\u000a    IN p_descripcion VARCHAR(500),\u000d\u000a    IN p_monto_objetivo DECIMAL(14,2),\u000d\u000a    IN p_fecha_objetivo DATE,\u000d\u000a    IN p_prioridad VARCHAR(10),\u000d\u000a    IN p_estado VARCHAR(10),\u000d\u000a    IN p_modificado_por VARCHAR(100)\u000d\u000a\u000d\u000a)\u000d\u000aMODIFIES SQL DATA\u000d\u000aBEGIN ATOMIC\u000d\u000a    DECLARE v_count INT;\u000d\u000a    DECLARE v_monto_ahorrado DECIMAL(14,2);\u000d\u000a\u0009DECLARE v_fecha_inicio DATE;\u000d\u000a\u0009DECLARE v_subcategoria BIGINT;\u000d\u000a\u0009\u000d\u000a\u0009 SELECT COUNT(*)INTO v_count FROM META_AHORRO WHERE Id_Ahorro=p_id_meta;\u000d\u000a    IF v_count=0 THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='La meta indicada no existe';\u000d\u000a    END IF;\u000d\u000a\u0009 \u000d\u000a\u0009--aqui obtengo el monto_ahorrado actual para validar\u000d\u000a\u0009SELECT Monto_ahorrado INTO v_monto_ahorrado FROM META_AHORRO WHERE Id_Ahorro=p_id_meta;\u000d\u000a\u0009\u000d\u000a\u0009--si cambian montos, validar que monto_ahorrado <= nuevo objetivo\u000d\u000a\u0009 IF p_monto_objetivo IS NOT NULL AND v_monto_ahorrado>p_monto_objetivo THEN\u000d\u000a        SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='No se puede disminuir el objetivo por debajo del monto ya ahorrado';\u000d\u000a     END IF;\u000d\u000a\u0009\u000d\u000a\u0009--si cambia fecha objetivo, validar que sea posterior a inicio actual\u000d\u000a\u0009 IF p_fecha_objetivo IS NOT NULL THEN\u000d\u000a        SELECT Fecha_inicio INTO v_fecha_inicio FROM META_AHORRO WHERE Id_Ahorro=p_id_meta;\u000d\u000a        IF p_fecha_objetivo<=v_fecha_inicio THEN\u000d\u000a            SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='La fecha objetivo debe ser posterior a la fecha de inicio';\u000d\u000a        END IF;\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009--si cambian estado a 'en_progreso' tengo q asegurarme que no hay otra meta en_progreso para la misma subcategoria\u000d\u000a\u0009IF p_estado='en_progreso'then\u000d\u000a\u0009\u0009SELECT Id_subcategoria INTO v_subcategoria FROM META_AHORRO WHERE Id_Ahorro = p_id_meta;\u000d\u000a\u0009\u0009IF exists(SELECT 1 FROM META_AHORRO m \u000d\u000a\u0009\u0009\u0009WHERE m.Id_subcategoria=v_subcategoria\u000d\u000a\u0009\u0009\u0009AND m.Estado='en_progreso'\u000d\u000a\u0009\u0009\u0009AND m.Id_ahorro<>p_id_meta)THEN\u000d\u000a\u0009     SIGNAL SQLSTATE '45000'SET MESSAGE_TEXT='Ya existe otra meta en progreso para la misma subcategoria';\u000d\u000a        END IF;\u000d\u000a    END IF;\u000d\u000a\u0009\u000d\u000a\u0009--ahora si actualizacionnnnnnnnnnnnnnnnnnnnnnnnnnnnnn,usare coalesce para para no sobrescribir con NULL si el parametro es NULL\u000d\u000a\u0009 UPDATE META_AHORRO\u000d\u000a     SET\u000d\u000a        Nombre=COALESCE(p_nombre, Nombre),\u000d\u000a        Descripcion_detallada=COALESCE(p_descripcion, Descripcion_detallada),\u000d\u000a        Monto_total_alcanzar=COALESCE(p_monto_objetivo, Monto_total_alcanzar),\u000d\u000a        Fecha_objetivo=COALESCE(p_fecha_objetivo, Fecha_objetivo),\u000d\u000a        Prioridad=COALESCE(LOWER(p_prioridad), Prioridad),\u000d\u000a        Estado=COALESCE(p_estado, Estado),\u000d\u000a        modificado_en=CURRENT_TIMESTAMP,\u000d\u000a        modificado_por='royum'\u000d\u000a     WHERE Id_Ahorro=p_id_meta;\u000d\u000a\u0009\u000d\u000a\u0009--si despues de la actualizacion el monto_ahorrado >= objetivo, forzar estado completed\u000d\u000a\u0009UPDATE META_AHORRO\u000d\u000a    SET Estado='completada'\u000d\u000a    WHERE Id_Ahorro=p_id_meta\u000d\u000a      AND Monto_ahorrado>= Monto_total_alcanzar;\u000d\u000aEND
/*C4*/INSERT INTO CATEGORIA VALUES(8,'Limpieza','Gastos de limpieza','gasto','2025-12-07 00:04:44.944888',NULL,'royum',NULL)
INSERT INTO SUBCATEGORIA VALUES(9,8,'Subcategor\u00eda por defecto de la categoria','Limpieza',TRUE,TRUE,'2025-12-07 00:04:44.944888',NULL,'system',NULL)
COMMIT
/*C11*/SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
SET SCHEMA PUBLIC
